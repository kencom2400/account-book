# 要件定義書 - 資産管理アプリケーション

## 1. プロジェクト概要

個人の資産管理を効率的に行うためのWebアプリケーションの開発。
各金融機関のAPIを利用して取引履歴を自動取得し、カテゴリ別に分類・集計・分析を行う。

## 2. 目的

- 複数の金融機関の資産を一元管理
- 収支の可視化と分析
- 手動入力の負担軽減
- 月次・年次での収支バランスの把握

## 3. システム概要

### 3.1 システム構成

```
┌─────────────────────────────────────────────────────┐
│                   Frontend (Next.js)                 │
│              ユーザーインターフェース                  │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│                 Backend (NestJS)                     │
│              ビジネスロジック・API連携                 │
└────────────────────┬────────────────────────────────┘
                     │
┌────────────────────┴────────────────────────────────┐
│            外部金融機関API                            │
│     (銀行、クレジットカード、証券会社等)                │
└─────────────────────────────────────────────────────┘
```

### 3.2 データフロー

1. バックエンドが各金融機関APIから取引データを取得
2. 取得したデータをカテゴリ分類してローカル保存（JSON形式）
3. フロントエンドでデータを可視化・分析

## 4. 機能要件

### 4.1 データ取得機能

#### 4.1.1 金融機関連携
- **FR-001**: 銀行口座との連携
- **FR-002**: クレジットカードとの連携
- **FR-003**: 証券会社との連携
- **FR-004**: アプリ起動時のバックグラウンド接続確認
- **FR-005**: 接続失敗時のポップアップ通知

#### 4.1.2 取引履歴取得
- **FR-006**: 各金融機関から利用履歴を自動取得
- **FR-007**: 取得データのローカル保存（JSON形式）

### 4.2 データ分類機能

#### 4.2.1 カテゴリ分類
- **FR-008**: 取引データを5つの主要カテゴリに分類
  - 収入：資産増加の取引（給与、配当、売上等）
  - 支出：資産減少の取引（購入、支払い等）
  - 振替：資産間の移動（口座間送金、カード引落し等）
  - 返済：借入金の返済
  - 投資：投資活動に関する取引

#### 4.2.2 費目分類
- **FR-009**: MoneyTree、MoneyForward等を参考にした詳細費目分類
- **FR-010**: ユーザーによる費目の手動修正機能
- **FR-011**: 費目の追加・編集・削除機能

### 4.3 クレジットカード管理機能

- **FR-012**: クレジットカード利用明細の月別集計
- **FR-013**: 銀行引落額との自動照合機能
- **FR-014**: 支払いステータス管理（未支払い / 支払済）
- **FR-015**: 不一致時のアラート表示

### 4.4 集計・分析機能

#### 4.4.1 月次集計
- **FR-016**: 月別の収支集計
- **FR-017**: 金融機関別の集計
- **FR-018**: カテゴリ別の集計
- **FR-019**: 費目別の集計

#### 4.4.2 年次集計
- **FR-020**: 年間の収支推移表示
- **FR-021**: イベントメモ機能（就学、高額購入等）
- **FR-022**: イベントと収支の紐付け

### 4.5 可視化機能

- **FR-023**: 月間収支のグラフ表示
- **FR-024**: 年間収支のグラフ表示
- **FR-025**: カテゴリ別円グラフ表示
- **FR-026**: 金融機関別資産残高の表示
- **FR-027**: 収支推移のトレンド表示

### 4.6 設定機能

- **FR-028**: 金融機関接続設定の画面管理
- **FR-029**: 認証情報の登録・更新・削除
- **FR-030**: データ同期間隔の設定
- **FR-031**: カテゴリ・費目のカスタマイズ

## 5. 非機能要件

### 5.1 セキュリティ

- **NFR-001**: 金融機関APIの認証情報を暗号化して保存
- **NFR-002**: データはローカルで保管（将来的にDB/SQLite移行）
- **NFR-003**: 通信時のHTTPS使用
- **NFR-004**: セッション管理とタイムアウト

### 5.2 パフォーマンス

- **NFR-005**: アプリ起動から画面表示まで3秒以内
- **NFR-006**: データ取得処理はバックグラウンドで実行
- **NFR-007**: 大量データでも快適な操作性

### 5.3 可用性

- **NFR-008**: オフライン時も過去データの閲覧が可能
- **NFR-009**: API接続失敗時の適切なエラーハンドリング

### 5.4 保守性

- **NFR-010**: Onion Architectureによるレイヤー分離
- **NFR-011**: 拡張性を考慮した設計
- **NFR-012**: コードの可読性とドキュメント整備

### 5.5 互換性

- **NFR-013**: モダンブラウザ対応（Chrome, Firefox, Safari, Edge最新版）
- **NFR-014**: レスポンシブデザイン対応

## 6. アーキテクチャ

### 6.1 システム構成

```
account-book/
├── apps/
│   ├── frontend/        # Next.js フロントエンド
│   └── backend/         # NestJS バックエンド
├── libs/
│   └── types/          # 共通型定義
├── packages/           # 共有パッケージ
└── docs/              # ドキュメント
```

### 6.2 技術スタック

#### フロントエンド
- **フレームワーク**: Next.js
- **言語**: TypeScript
- **状態管理**: React Context API / Zustand
- **UIライブラリ**: 検討中（Material-UI, Chakra UI等）
- **グラフ描画**: Chart.js / Recharts

#### バックエンド
- **フレームワーク**: NestJS
- **言語**: TypeScript
- **データ保存**: JSON（初期）→ SQLite/PostgreSQL（将来）
- **API通信**: Axios

#### 共通
- **環境管理**: pnpm workspace / monorepo構成
- **パッケージマネージャー**: pnpm
- **コード品質**: ESLint, Prettier
- **テスト**: Jest, Testing Library

### 6.3 Onion Architecture

```
┌──────────────────────────────────────┐
│        Presentation Layer            │  ← Controller, UI Components
│  (apps/frontend, apps/backend/api)   │
├──────────────────────────────────────┤
│       Application Layer              │  ← Use Cases, Application Services
│      (apps/backend/services)         │
├──────────────────────────────────────┤
│         Domain Layer                 │  ← Entities, Domain Services
│    (apps/backend/domain)             │
├──────────────────────────────────────┤
│      Infrastructure Layer            │  ← DB, External API, File System
│  (apps/backend/infrastructure)       │
└──────────────────────────────────────┘
```

#### レイヤー説明

1. **Domain Layer（ドメイン層）**
   - ビジネスロジックの中核
   - エンティティ、値オブジェクト、ドメインサービス
   - 他のレイヤーに依存しない

2. **Application Layer（アプリケーション層）**
   - ユースケースの実装
   - ドメイン層を組み合わせて機能を実現
   - トランザクション制御

3. **Infrastructure Layer（インフラストラクチャ層）**
   - 外部システムとの接続
   - データ永続化（JSON保存、将来的にDB）
   - 金融機関API連携

4. **Presentation Layer（プレゼンテーション層）**
   - ユーザーインターフェース
   - APIエンドポイント
   - リクエスト/レスポンス変換

## 7. データ設計

### 7.1 主要エンティティ

#### Transaction（取引）
```typescript
interface Transaction {
  id: string;
  date: Date;
  amount: number;
  category: CategoryType;
  subcategory: string;
  description: string;
  institutionId: string;
  institutionType: InstitutionType;
  accountId: string;
  status: TransactionStatus;
  isReconciled: boolean;
  relatedTransactionId?: string; // 振替の場合の関連取引
  createdAt: Date;
  updatedAt: Date;
}
```

#### CategoryType（カテゴリタイプ）
```typescript
enum CategoryType {
  INCOME = 'income',      // 収入
  EXPENSE = 'expense',    // 支出
  TRANSFER = 'transfer',  // 振替
  REPAYMENT = 'repayment', // 返済
  INVESTMENT = 'investment' // 投資
}
```

#### Institution（金融機関）
```typescript
interface Institution {
  id: string;
  name: string;
  type: InstitutionType;
  apiEndpoint: string;
  credentials: EncryptedCredentials;
  isConnected: boolean;
  lastSyncedAt?: Date;
  accounts: Account[];
}
```

#### Account（口座）
```typescript
interface Account {
  id: string;
  institutionId: string;
  accountNumber: string;
  accountName: string;
  balance: number;
  currency: string;
}
```

#### CreditCardPayment（クレジットカード支払い）
```typescript
interface CreditCardPayment {
  id: string;
  cardId: string;
  month: string; // YYYY-MM
  totalAmount: number;
  transactions: Transaction[];
  bankWithdrawalId?: string;
  status: PaymentStatus; // 未支払い / 支払済
  dueDate: Date;
}
```

#### Event（イベント）
```typescript
interface Event {
  id: string;
  date: Date;
  title: string;
  description: string;
  category: EventCategory;
  relatedTransactions: string[];
}
```

### 7.2 データ保存

#### 初期フェーズ
- JSON形式でローカルファイルシステムに保存
- ファイル構造:
  ```
  data/
  ├── transactions/
  │   └── YYYY-MM.json
  ├── institutions/
  │   └── institutions.json
  ├── accounts/
  │   └── accounts.json
  └── settings/
      └── config.json
  ```

#### 将来フェーズ
- SQLite または PostgreSQLへの移行
- データマイグレーション機能の実装

## 8. ユースケース

### 8.1 UC-001: 金融機関連携設定

**アクター**: ユーザー

**前提条件**: アプリケーションにログイン済み

**フロー**:
1. ユーザーが設定画面から金融機関連携を選択
2. 連携する金融機関を選択
3. 認証情報を入力
4. システムが接続テストを実施
5. 成功時、金融機関情報を保存

**代替フロー**:
- 接続失敗時、エラーメッセージを表示

### 8.2 UC-002: 取引データ自動取得

**アクター**: システム（バックグラウンド）

**前提条件**: 金融機関連携済み

**フロー**:
1. アプリ起動時または定期実行時
2. 登録された金融機関にAPI接続
3. 新規取引データを取得
4. カテゴリを自動分類
5. ローカルに保存
6. UI上で最新データを表示

**代替フロー**:
- 接続失敗時、ユーザーに通知

### 8.3 UC-003: 月間収支確認

**アクター**: ユーザー

**前提条件**: 取引データが存在する

**フロー**:
1. ユーザーが月次レポート画面を開く
2. 対象月を選択
3. システムが以下を表示:
   - 収入合計
   - 支出合計
   - 収支差額
   - カテゴリ別内訳
   - 金融機関別内訳
4. グラフで可視化

### 8.4 UC-004: クレジットカード支払い照合

**アクター**: ユーザー

**前提条件**: クレジットカード利用データと銀行引落しデータが存在

**フロー**:
1. システムが月次でクレジットカード利用額を集計
2. 銀行からの引落し額と自動照合
3. 一致した場合、支払済みステータスに更新
4. 不一致の場合、アラート表示
5. ユーザーが手動で確認・修正

### 8.5 UC-005: 年間収支分析

**アクター**: ユーザー

**前提条件**: 1年以上のデータが存在

**フロー**:
1. ユーザーが年次レポート画面を開く
2. 対象年を選択
3. システムが表示:
   - 月別収支推移グラフ
   - 年間収入・支出合計
   - カテゴリ別年間推移
   - イベントマーカー
4. ユーザーがイベントメモを追加・編集可能

### 8.6 UC-006: 費目の手動修正

**アクター**: ユーザー

**前提条件**: 取引データが存在

**フロー**:
1. ユーザーが取引一覧から対象取引を選択
2. 費目（カテゴリ・サブカテゴリ）を変更
3. システムが変更を保存
4. 集計データを再計算

## 9. 開発フェーズ

### Phase 1: 基盤構築
- [x] プロジェクト構成の作成
- [ ] Next.js, NestJSの環境構築
- [ ] 共通型定義の作成
- [ ] Onion Architecture の基本構造実装

### Phase 2: コア機能実装
- [ ] データモデルの実装
- [ ] JSON保存機能の実装
- [ ] 取引データCRUD機能
- [ ] カテゴリ分類ロジック

### Phase 3: 金融機関連携
- [ ] 金融機関API連携基盤
- [ ] 銀行API連携
- [ ] クレジットカードAPI連携
- [ ] 証券会社API連携

### Phase 4: UI/UX実装
- [ ] ダッシュボード画面
- [ ] 月次レポート画面
- [ ] 年次レポート画面
- [ ] 設定画面
- [ ] グラフ・チャート実装

### Phase 5: 高度な機能
- [ ] クレジットカード照合機能
- [ ] イベント管理機能
- [ ] データエクスポート機能
- [ ] 通知機能

### Phase 6: 改善・最適化
- [ ] パフォーマンス最適化
- [ ] エラーハンドリング改善
- [ ] ユーザビリティ改善
- [ ] DB移行（SQLite/PostgreSQL）

## 10. 今後の拡張機能（Future）

- **予測機能**: 今後の収支バランスの予測（機械学習）
- **予算管理**: カテゴリ別予算設定とアラート
- **定期支出管理**: サブスクリプション管理
- **資産推移予測**: 長期的な資産形成シミュレーション
- **共有機能**: 家族間での資産情報共有
- **バックアップ**: クラウドバックアップ機能

## 11. 制約事項

- 初期フェーズではJSON形式での保存のため、大量データ時の性能制限あり
- 金融機関APIの利用可否は各機関の提供状況に依存
- オフライン時は新規データ取得不可（閲覧のみ）

## 12. 用語集

| 用語 | 説明 |
|------|------|
| 振替 | 資産間で相殺される取引（クレジットカード引落し等） |
| 照合 | クレジットカード利用額と銀行引落額の突合せ |
| 費目 | 取引の詳細カテゴリ（食費、交通費等） |
| イベント | 特定の出来事（就学、購入等）のマーカー |
| 金融機関 | 銀行、クレジットカード会社、証券会社等の総称 |

---

**文書バージョン**: 1.0
**作成日**: 2025-11-15
**最終更新日**: 2025-11-15

