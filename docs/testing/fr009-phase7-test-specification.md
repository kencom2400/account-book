# FR-009 Phase 7: テスト仕様書

最終更新日: 2025-11-26

---

## 📋 概要

このドキュメントでは、FR-009詳細費目分類機能のPhase 7で実装したテストの仕様を記載します。

**Phase 7の目的:**

- エンドツーエンド統合テストの実装
- パフォーマンステストの実装
- データ整合性テストの実装
- 全体カバレッジの確認

**注意:** Phase 2〜6で既にユニットテスト・E2Eテストは実装済みです。

---

## 🎯 テスト目標

### カバレッジ目標

| テストタイプ               | 目標カバレッジ | 備考                 |
| -------------------------- | -------------- | -------------------- |
| ユニットテスト（Backend）  | 80%以上        | Phase 2〜4で達成済み |
| ユニットテスト（Frontend） | 80%以上        | Phase 6で達成済み    |
| E2Eテスト                  | 主要フロー100% | Phase 5〜6で達成済み |
| 統合テスト                 | 全体フロー100% | Phase 7で実装        |

### パフォーマンス目標

| 項目                 | 目標値    | 測定方法               |
| -------------------- | --------- | ---------------------- |
| 1件の分類            | 50ms以内  | APIレスポンスタイム    |
| 100件の一括分類      | 3秒以内   | APIレスポンスタイム    |
| 店舗マスタ検索       | 10ms以内  | 内部処理時間           |
| サブカテゴリ一覧取得 | 100ms以内 | APIレスポンスタイム    |
| ページ初期表示       | 500ms以内 | First Contentful Paint |
| 階層構造展開         | 50ms以内  | UIレスポンス時間       |

---

## 📊 Phase 7 実装テスト一覧

### 1. エンドツーエンド統合テスト

**ファイル:** `apps/backend/test/subcategory-classification-integration.e2e-spec.ts`

**目的:** 取引受信から分類確定までの全体フローをテストする

#### テストケース

##### 1.1 高信頼度取引: 自動分類→そのまま確定

**シナリオ:**

1. 取引データを受信（MoneyForward連携想定）
2. 自動分類を実行
3. 店舗マスタにヒットして高信頼度で分類される
4. ユーザー確認なしで自動確定

**期待結果:**

- 信頼度90%以上
- サブカテゴリが正しく設定される
- 分類理由が `MERCHANT_MATCH`

**テストデータ:**

- 説明: "スターバックス 表参道店"
- 金額: -450円
- カテゴリ: EXPENSE
- 期待サブカテゴリ: `food_cafe`

##### 1.2 中信頼度取引: 自動分類→手動修正→確定

**シナリオ:**

1. 取引データを受信
2. 自動分類を実行（低〜中信頼度）
3. フロントエンドでユーザーが手動修正
4. 確定

**期待結果:**

- 初回分類: 信頼度90%未満
- 手動修正後: 信頼度100%、理由が `MANUAL`

**テストデータ:**

- 説明: "未知の店舗での購入"
- 金額: -1200円
- カテゴリ: EXPENSE
- ユーザー選択: `food_groceries`

##### 1.3 複数取引の一括分類フロー

**シナリオ:**

1. 複数の取引データを準備
2. 一括分類APIを呼び出し
3. 各取引が正しく分類されることを確認

**期待結果:**

- すべての取引が分類される
- 各取引の信頼度が適切
- レスポンス時間が基準内

**テストデータ:**

- 3件の取引（スターバックス、セブンイレブン、JR東日本）

##### 1.4 店舗マスタ学習フロー

**シナリオ:**

1. 初回取引（未知の店舗）→低信頼度で分類
2. ユーザーが手動でサブカテゴリを選択
3. 店舗マスタに学習登録
4. 2回目の取引→高信頼度で自動分類

**期待結果:**

- 初回: 信頼度低い
- 学習後: 同じ店舗で高信頼度

**テストデータ:**

- 説明: "ドトールコーヒー 渋谷店"、"ドトールコーヒー 新宿店"

##### 1.5 エラーケースとエッジケース

- 無効な取引データでエラーが返される
- 存在しないサブカテゴリIDを指定した場合
- 一括分類で一部の取引が失敗した場合

---

### 2. サブカテゴリ分類パフォーマンステスト（Backend）

**ファイル:** `apps/backend/test/performance/subcategory-performance.perf.spec.ts`

**目的:** APIのレスポンスタイムとスループットを検証する

#### テストケース

##### 2.1 単一分類のパフォーマンス

| テスト項目           | 目標値   | 測定項目            |
| -------------------- | -------- | ------------------- |
| 店舗マスタヒット時   | 50ms以内 | APIレスポンスタイム |
| 店舗マスタ未ヒット時 | 50ms以内 | APIレスポンスタイム |

##### 2.2 一括分類のパフォーマンス

| 件数  | 目標値    | 測定項目            |
| ----- | --------- | ------------------- |
| 10件  | 300ms以内 | APIレスポンスタイム |
| 50件  | 1.5秒以内 | APIレスポンスタイム |
| 100件 | 3秒以内   | APIレスポンスタイム |

##### 2.3 サブカテゴリ一覧取得のパフォーマンス

| テスト項目         | 目標値    | 測定項目            |
| ------------------ | --------- | ------------------- |
| 全サブカテゴリ一覧 | 100ms以内 | APIレスポンスタイム |
| カテゴリ別一覧     | 50ms以内  | APIレスポンスタイム |
| サブカテゴリ詳細   | 20ms以内  | APIレスポンスタイム |

##### 2.4 階層構造処理のパフォーマンス

| テスト項目           | 目標値    | 測定項目            |
| -------------------- | --------- | ------------------- |
| 階層構造を含む全取得 | 200ms以内 | APIレスポンスタイム |

##### 2.5 並行リクエストのパフォーマンス

| 並行数 | 目標値    | 測定項目     |
| ------ | --------- | ------------ |
| 10並行 | 500ms以内 | 並行実行時間 |
| 50並行 | 2秒以内   | 並行実行時間 |

##### 2.6 メモリ使用量のチェック

- 1000件の分類を10回実行後
- メモリ増加が50MB以内であること

---

### 3. フロントエンドパフォーマンステスト

**ファイル:** `apps/frontend/e2e/subcategory-performance.spec.ts`

**目的:** フロントエンドのレスポンス性能を検証する

#### テストケース

##### 3.1 ページ表示のパフォーマンス

| テスト項目           | 目標値    | 測定項目               |
| -------------------- | --------- | ---------------------- |
| ページ初期表示       | 500ms以内 | First Contentful Paint |
| サブカテゴリ一覧取得 | 100ms以内 | APIレスポンス          |
| 取引一覧表示         | 200ms以内 | 表示完了時間           |

##### 3.2 UIインタラクションのパフォーマンス

| テスト項目         | 目標値    | 測定項目           |
| ------------------ | --------- | ------------------ |
| 階層構造展開       | 50ms以内  | UIレスポンス       |
| 検索フィルタリング | 100ms以内 | フィルタリング完了 |
| カテゴリ選択UI     | 30ms以内  | ドロップダウン表示 |
| サブカテゴリ保存   | 200ms以内 | 保存完了           |

##### 3.3 大量データのパフォーマンス

| テスト項目     | 目標値    | 測定項目       |
| -------------- | --------- | -------------- |
| 100件表示      | 1秒以内   | 全行表示完了   |
| 仮想スクロール | 200ms以内 | スクロール更新 |

##### 3.4 自動分類のパフォーマンス

| テスト項目       | 目標値    | 測定項目 |
| ---------------- | --------- | -------- |
| 自動分類実行     | 200ms以内 | 結果表示 |
| 分類結果表示     | 50ms以内  | UI更新   |
| 連続分類（10回） | 2秒以内   | 合計時間 |

---

### 4. データ整合性テスト

**ファイル:** `apps/backend/test/subcategory-data-integrity.e2e-spec.ts`

**目的:** データベースの整合性制約を検証する

#### テストケース

##### 4.1 外部キー制約のテスト

| テスト項目                               | 期待結果 |
| ---------------------------------------- | -------- |
| 存在しない親カテゴリ指定                 | エラー   |
| 存在しないサブカテゴリを店舗マスタに指定 | エラー   |
| 子カテゴリ存在時に親カテゴリ削除         | エラー   |

##### 4.2 トランザクション整合性のテスト

| テスト項目             | 期待結果                   |
| ---------------------- | -------------------------- |
| エラー時のロールバック | データが挿入されない       |
| 並行更新時の競合処理   | 最後のコミットが反映される |

##### 4.3 データの一貫性テスト

| テスト項目                   | 期待結果                 |
| ---------------------------- | ------------------------ |
| 親子カテゴリのタイプ一致     | 同じカテゴリタイプ       |
| 循環参照の防止               | エラー                   |
| display_order の重複チェック | 同じ親内で重複なし       |
| confidence の範囲チェック    | 0〜1の範囲内             |
| is_default フラグの確認      | 正しく設定されている     |
| is_active フラグの動作       | 非アクティブは返されない |

##### 4.4 JSON型フィールドの整合性テスト

| テスト項目         | 期待結果   |
| ------------------ | ---------- |
| 正しいJSON配列形式 | パース成功 |
| 不正なJSON形式     | エラー     |

##### 4.5 NULL値とデフォルト値のテスト

| テスト項目            | 期待結果   |
| --------------------- | ---------- |
| parent_id に NULL     | 許可される |
| 必須フィールドに NULL | エラー     |

##### 4.6 一意性制約のテスト

| テスト項目           | 期待結果 |
| -------------------- | -------- |
| 同じIDのサブカテゴリ | エラー   |
| 同じIDの店舗マスタ   | エラー   |

---

## 🔧 テスト実行方法

### ユニットテスト

```bash
# バックエンド
cd apps/backend
pnpm test

# フロントエンド
cd apps/frontend
pnpm test
```

### E2Eテスト

```bash
# バックエンドE2E（統合テスト含む）
cd apps/backend
pnpm test:e2e

# フロントエンドE2E
cd apps/frontend
pnpm test:e2e
```

### パフォーマンステスト

```bash
# バックエンドパフォーマンステスト
cd apps/backend
pnpm test:perf

# フロントエンドパフォーマンステスト
cd apps/frontend
pnpm test:e2e apps/frontend/e2e/subcategory-performance.spec.ts
```

### カバレッジチェック

```bash
# FR-009 Phase 7 専用カバレッジチェック
./scripts/test/check-coverage-fr009.sh
```

---

## 📈 カバレッジ確認

### カバレッジレポートの生成

```bash
# バックエンド
cd apps/backend
pnpm test:cov

# フロントエンド
cd apps/frontend
pnpm test --coverage
```

### レポート確認

- バックエンド: `apps/backend/coverage/lcov-report/index.html`
- フロントエンド: `apps/frontend/coverage/lcov-report/index.html`

---

## 🔗 関連ドキュメント

- [FR-009 詳細設計書](../detailed-design/FR-009_detailed-category-classification/README.md)
- [テスト設計書](../test-design.md)
- [テストカバレッジ使用ガイド](./coverage-usage-guide.md)
- [テストカバレッジレポート](./fr009-phase7-coverage-report.md)

---

## ✅ Phase 2〜6 で実装済みのテスト

### Phase 2: Domain層ユニットテスト

- Entity、Value Object、Domain Serviceのテスト
- 分類ロジックのテスト

### Phase 3: Infrastructure層ユニットテスト

- Repository実装のテスト
- 店舗マスタ検索のテスト
- データベースアクセスのテスト

### Phase 4: Application層ユニットテスト

- UseCaseのテスト
- アプリケーションサービスのテスト

### Phase 5: Presentation層E2Eテスト

- `apps/backend/test/subcategory.e2e-spec.ts`
- API経由でのサブカテゴリ取得・分類テスト

### Phase 6: Frontendコンポーネント・E2Eテスト

- `apps/frontend/e2e/transaction-classification.spec.ts`
- `apps/frontend/e2e/classification.spec.ts`
- コンポーネント単位のテスト

---

## 📝 テストデータ

### サブカテゴリデータ

| ID                  | カテゴリタイプ | 名前       | 親ID      | 備考       |
| ------------------- | -------------- | ---------- | --------- | ---------- |
| food                | EXPENSE        | 食費       | NULL      | 親カテゴリ |
| food_cafe           | EXPENSE        | カフェ     | food      | 子カテゴリ |
| food_groceries      | EXPENSE        | 食料品     | food      | 子カテゴリ |
| food_dining_out     | EXPENSE        | 外食       | food      | 子カテゴリ |
| transport           | EXPENSE        | 交通費     | NULL      | 親カテゴリ |
| transport_train_bus | EXPENSE        | 電車・バス | transport | 子カテゴリ |

### 店舗マスタデータ

| ID                 | 名前           | エイリアス              | デフォルトサブカテゴリ | 信頼度 |
| ------------------ | -------------- | ----------------------- | ---------------------- | ------ |
| merchant_starbucks | スターバックス | ["STARBUCKS", "スタバ"] | food_cafe              | 0.98   |
| merchant_seven     | セブンイレブン | ["7-ELEVEN", "7-11"]    | food_groceries         | 0.95   |
| merchant_jr_east   | JR東日本       | ["JR EAST", "JREAST"]   | transport_train_bus    | 0.90   |

---

## 🐛 既知の問題と制限事項

### 現在の制限事項

1. **取引API未実装**
   - 統合テストでは取引作成APIが未実装のため、モックデータを使用
   - 実際のAPIが実装されたら、テストを更新する必要がある

2. **確定API未実装**
   - 分類確定APIが未実装のため、確定フローの一部をスキップ
   - 実際のAPIが実装されたら、テストを更新する必要がある

3. **店舗マスタ学習API未実装**
   - 店舗マスタの学習機能が未実装
   - 現在はテストデータを直接SQLで挿入

### 今後の対応

- FR-006（取引履歴取得）が実装されたら、統合テストを更新
- FR-010（費目の手動修正）が実装されたら、確定フローのテストを追加
- 店舗マスタ学習機能が実装されたら、学習フローのテストを強化

---

## 📊 まとめ

Phase 7では、以下のテストを実装しました：

- ✅ エンドツーエンド統合テスト（全体フロー）
- ✅ パフォーマンステスト（Backend・Frontend）
- ✅ データ整合性テスト
- ✅ カバレッジ確認スクリプト

これにより、FR-009詳細費目分類機能の品質が保証されます。
