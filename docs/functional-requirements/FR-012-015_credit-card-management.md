# 機能要件書：クレジットカード管理機能

**文書バージョン**: 1.0  
**作成日**: 2025-11-15  
**最終更新日**: 2025-11-15

## 目次
- [FR-012: クレジットカード月別集計](#fr-012-クレジットカード月別集計)
- [FR-013: 銀行引落額との自動照合](#fr-013-銀行引落額との自動照合)
- [FR-014: 支払いステータス管理](#fr-014-支払いステータス管理)
- [FR-015: 不一致時のアラート表示](#fr-015-不一致時のアラート表示)

---

## FR-012: クレジットカード月別集計

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-012 |
| 機能名 | クレジットカード利用明細の月別集計 |
| 優先度 | 高 |
| 対応Phase | Phase 5 |

### 概要
クレジットカードの利用明細を月別に集計し、支払い予定額を算出する。各カードの締め日に基づいて正確な集計を行う。

### 詳細仕様

#### 集計対象
- クレジットカード利用明細（支出カテゴリ）
- 各カード会社から取得したデータ
- ポイント利用・キャッシュバック等の控除項目

#### 集計単位
- カード毎
- 請求月毎（締め日ベース）

#### 締め日パターン対応
- 月末締め（翌月27日払い等）
- 15日締め（翌月10日払い等）
- 10日締め（翌月5日払い等）
- カスタム締め日対応

#### 入力
- カード選択
- 集計期間（開始年月〜終了年月）
- 締め日情報（カード設定から自動取得）

#### 出力
- 月別集計レポート
  ```typescript
  interface MonthlyCardSummary {
    cardId: string;
    cardName: string;
    billingMonth: string; // YYYY-MM
    closingDate: Date;
    paymentDate: Date;
    totalAmount: number;
    transactionCount: number;
    categoryBreakdown: CategoryAmount[];
    transactions: Transaction[];
    discounts: Discount[];
    netPaymentAmount: number;
    status: PaymentStatus;
  }
  ```

#### 処理フロー
```
1. ユーザーがクレジットカード管理画面を開く
2. システムが登録済みカード一覧を表示
3. ユーザーがカードと集計期間を選択
4. [データ抽出]
   a. 該当期間のカード利用明細を取得
   b. 締め日に基づいて請求月を判定
5. [集計処理]
   a. 利用金額を合計
   b. カテゴリ別内訳を算出
   c. ポイント利用・割引を適用
   d. 最終支払額を算出
6. [表示]
   a. 月別一覧を表示
   b. 詳細明細へのドリルダウン対応
   c. グラフ表示
```

#### 計算ロジック

##### 請求月の判定
```typescript
function determineBillingMonth(
  transactionDate: Date,
  closingDay: number
): string {
  const year = transactionDate.getFullYear();
  const month = transactionDate.getMonth() + 1;
  const day = transactionDate.getDate();
  
  if (day <= closingDay) {
    // 当月締め → 当月請求
    return `${year}-${String(month).padStart(2, '0')}`;
  } else {
    // 翌月締め → 翌月請求
    const nextMonth = month === 12 ? 1 : month + 1;
    const nextYear = month === 12 ? year + 1 : year;
    return `${nextYear}-${String(nextMonth).padStart(2, '0')}`;
  }
}
```

##### 支払額計算
```typescript
function calculateNetPayment(
  totalAmount: number,
  discounts: Discount[]
): number {
  let netAmount = totalAmount;
  
  for (const discount of discounts) {
    switch (discount.type) {
      case 'POINT':
        netAmount -= discount.amount;
        break;
      case 'CASHBACK':
        netAmount -= discount.amount;
        break;
      case 'CAMPAIGN':
        netAmount -= discount.amount;
        break;
    }
  }
  
  return Math.max(0, netAmount);
}
```

#### バリデーション
- カードID存在チェック
- 集計期間の妥当性チェック（開始 <= 終了）
- 締め日の妥当性チェック（1〜31日）

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| CC001 | カードが見つからない | カード登録を確認 |
| CC002 | 締め日が設定されていない | カード設定で締め日を登録 |
| CC003 | データ取得期間が長すぎる | 期間を短縮して再試行 |
| CC004 | 明細データが存在しない | データ同期を実施 |

#### パフォーマンス要件
- 1年分のデータ集計: 2秒以内
- リアルタイム計算（フィルタ変更時）: 500ms以内
- 大量明細対応: 1万件まで

#### セキュリティ考慮事項
- カード番号のマスキング表示
- 金額情報の暗号化保存

#### テストケース

##### TC-012-001: 月末締めの正常集計
- **前提**: 月末締め・翌月27日払いのカードが登録済み
- **入力**: 2025年1月の明細（20件）
- **期待結果**: 
  - 1/1〜1/31の取引が集計される
  - 支払日が2/27に設定される
  - 合計金額が正しく算出される

##### TC-012-002: 15日締めの正常集計
- **前提**: 15日締め・翌月10日払いのカードが登録済み
- **入力**: 1/10〜1/20の明細
- **期待結果**:
  - 1/10〜1/15の取引: 1月請求分
  - 1/16〜1/20の取引: 2月請求分

##### TC-012-003: ポイント利用の反映
- **前提**: 利用明細と5,000ポイント利用
- **入力**: 合計50,000円の利用
- **期待結果**: 支払額45,000円（5,000円分控除）

##### TC-012-004: 締め日跨ぎの処理
- **前提**: 20日締めのカード
- **入力**: 1/19と1/21の取引
- **期待結果**: それぞれ別の請求月に分類

#### UI/UX要件
- カード別タブ表示
- 月別カレンダー形式での選択
- 請求額の強調表示
- 未払い分のバッジ表示
- エクスポート機能（CSV, PDF）

#### 関連要件
- [FR-002: クレジットカードとの連携](FR-001-007_data-acquisition.md#fr-002-クレジットカードとの連携)
- [FR-008: 主要カテゴリ分類](FR-008-011_data-classification.md#fr-008-主要カテゴリ分類)
- [FR-013: 銀行引落額との自動照合](#fr-013-銀行引落額との自動照合)

#### 備考
- 分割払い・リボ払いは初期フェーズでは対象外
- Phase 6で分割払い対応を検討

---

## FR-013: 銀行引落額との自動照合

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-013 |
| 機能名 | 銀行引落額との自動照合機能 |
| 優先度 | 高 |
| 対応Phase | Phase 5 |

### 概要
クレジットカードの月別集計額と、銀行口座からの実際の引落額を自動的に照合し、一致・不一致を判定する。

### 詳細仕様

#### 照合対象
- クレジットカード月別集計額（FR-012で算出）
- 銀行口座からのカード引落取引

#### 照合タイミング
- 引落予定日の3日後（自動）
- ユーザーによる手動照合実行時
- データ同期完了時

#### 照合ロジック

##### マッチング条件
以下の条件をすべて満たす場合に一致と判定：

1. **金額一致**
   - 銀行引落額 = カード請求額
   - 許容誤差: ±0円（完全一致）

2. **日付範囲**
   - 引落日 = 支払予定日 ± 3営業日

3. **摘要マッチング**
   - 銀行取引の摘要にカード会社名が含まれる
   - 例: "カ－ド", "三井住友カ－ド", "クレジット"

##### マッチングアルゴリム
```typescript
interface ReconciliationResult {
  isMatched: boolean;
  confidence: number; // 0-100
  bankTransaction?: Transaction;
  cardSummary: MonthlyCardSummary;
  discrepancy?: Discrepancy;
}

function reconcilePayment(
  cardSummary: MonthlyCardSummary,
  bankTransactions: Transaction[]
): ReconciliationResult {
  // 1. 日付範囲でフィルタ
  const candidates = filterByDateRange(
    bankTransactions,
    cardSummary.paymentDate,
    3 // 営業日
  );
  
  // 2. 金額でフィルタ
  const amountMatches = candidates.filter(
    tx => tx.amount === cardSummary.netPaymentAmount
  );
  
  // 3. 摘要でフィルタ
  const descriptionMatches = amountMatches.filter(
    tx => matchesCardCompany(tx.description, cardSummary.cardName)
  );
  
  // 4. スコアリング
  if (descriptionMatches.length === 1) {
    return {
      isMatched: true,
      confidence: 100,
      bankTransaction: descriptionMatches[0],
      cardSummary
    };
  }
  
  // 5. 部分一致の評価
  if (amountMatches.length > 0) {
    return evaluatePartialMatch(amountMatches, cardSummary);
  }
  
  // 6. 不一致
  return {
    isMatched: false,
    confidence: 0,
    cardSummary,
    discrepancy: analyzeDiscrepancy(cardSummary, bankTransactions)
  };
}
```

#### 入力
- カード請求データ（MonthlyCardSummary）
- 銀行取引データ（支払予定日前後の期間）

#### 出力
- 照合結果
  ```typescript
  interface ReconciliationReport {
    reconciliationId: string;
    executedAt: Date;
    cardId: string;
    billingMonth: string;
    status: ReconciliationStatus; // MATCHED, UNMATCHED, PARTIAL
    results: ReconciliationResult[];
    summary: {
      total: number;
      matched: number;
      unmatched: number;
      partial: number;
    };
  }
  ```

#### 処理フロー
```
1. [トリガー] 引落予定日 + 3日後（自動実行）
2. [データ取得]
   a. 該当月のカード請求データを取得
   b. 引落予定日前後3日の銀行取引を取得
3. [照合処理]
   a. 金額・日付・摘要でマッチング
   b. 信頼度スコアを算出
4. [結果判定]
   - 完全一致: ステータスを「支払済」に更新
   - 不一致: アラート生成（FR-015）
   - 部分一致: 手動確認を促す
5. [記録]
   a. 照合結果をログ保存
   b. 関連取引をリンク
6. [通知]
   a. 結果をUI表示
   b. 不一致時はポップアップ
```

#### バリデーション
- カード請求データの存在確認
- 銀行取引データの存在確認
- 引落予定日の妥当性確認

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| RC001 | カード請求データが見つからない | データ同期を実施 |
| RC002 | 銀行取引データが取得できない | 銀行連携を確認 |
| RC003 | 引落予定日が未来 | 引落日到来後に再実行 |
| RC004 | 複数の候補取引が存在 | 手動で選択 |

#### パフォーマンス要件
- 1件の照合処理: 100ms以内
- 一括照合（全カード・1ヶ月分）: 3秒以内
- バックグラウンド処理で実行

#### セキュリティ考慮事項
- 照合ログの暗号化保存
- 個人情報のマスキング

#### テストケース

##### TC-013-001: 完全一致の照合
- **前提**: カード請求額50,000円、引落予定日2/27
- **入力**: 2/27の銀行取引50,000円（摘要: カード引落）
- **期待結果**: 
  - isMatched: true
  - confidence: 100
  - ステータス: 支払済

##### TC-013-002: 金額不一致
- **前提**: カード請求額50,000円
- **入力**: 銀行引落48,000円
- **期待結果**:
  - isMatched: false
  - アラート生成
  - 差額: -2,000円

##### TC-013-003: 日付ずれの許容
- **前提**: 引落予定日2/27（金）
- **入力**: 実際の引落3/2（月）※週末挟む
- **期待結果**: 営業日計算で一致と判定

##### TC-013-004: 複数候補の処理
- **前提**: カード請求額30,000円
- **入力**: 同日に30,000円の引落が2件
- **期待結果**: 手動選択を促すアラート

#### UI/UX要件
- 照合結果の一覧表示
- 一致/不一致のステータスバッジ
- 不一致詳細の表示
- 手動マッチング機能
- 照合履歴の閲覧

#### 関連要件
- [FR-001: 銀行口座との連携](FR-001-007_data-acquisition.md#fr-001-銀行口座との連携)
- [FR-012: クレジットカード月別集計](#fr-012-クレジットカード月別集計)
- [FR-014: 支払いステータス管理](#fr-014-支払いステータス管理)
- [FR-015: 不一致時のアラート表示](#fr-015-不一致時のアラート表示)

#### 備考
- 営業日計算は銀行カレンダーに準拠
- 将来的には機械学習による精度向上を検討

---

## FR-014: 支払いステータス管理

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-014 |
| 機能名 | クレジットカード支払いステータス管理 |
| 優先度 | 高 |
| 対応Phase | Phase 5 |

### 概要
クレジットカードの各請求月について、支払いステータス（未払い/支払済/確認中等）を管理する。

### 詳細仕様

#### ステータス定義

```typescript
enum PaymentStatus {
  PENDING = 'pending',           // 未払い（引落前）
  PROCESSING = 'processing',     // 処理中（引落予定日前後）
  PAID = 'paid',                 // 支払済（照合完了）
  OVERDUE = 'overdue',           // 延滞（引落日を過ぎても未払い）
  PARTIAL = 'partial',           // 一部支払い
  DISPUTED = 'disputed',         // 不一致（要確認）
  CANCELLED = 'cancelled',       // キャンセル
  MANUAL_CONFIRMED = 'manual_confirmed' // 手動確認済
}
```

#### ステータス遷移

```
[PENDING] 請求確定時
    ↓
    ├─→ [PROCESSING] 引落予定日の3日前
    │       ↓
    │       ├─→ [PAID] 照合成功
    │       ├─→ [DISPUTED] 照合失敗
    │       └─→ [OVERDUE] 引落日+7日経過
    │
    ├─→ [PARTIAL] 一部金額のみ引落
    ├─→ [CANCELLED] ユーザーがキャンセル
    └─→ [MANUAL_CONFIRMED] 手動で確認完了
```

#### ステータス自動更新トリガー

1. **PENDING → PROCESSING**
   - 条件: 引落予定日の3日前
   - アクション: データ同期を実施

2. **PROCESSING → PAID**
   - 条件: 照合成功（FR-013）
   - アクション: 関連取引をリンク

3. **PROCESSING → DISPUTED**
   - 条件: 照合失敗
   - アクション: アラート生成（FR-015）

4. **PROCESSING → OVERDUE**
   - 条件: 引落予定日+7日経過かつ未払い
   - アクション: 重要アラート生成

#### 入力
- カード請求情報
- 照合結果（FR-013）
- ユーザーの手動操作

#### 出力
- 更新されたステータス
- ステータス変更履歴
- 通知・アラート

#### 処理フロー

##### 自動ステータス更新
```
1. [スケジューラー] 毎日深夜0時実行
2. [対象抽出]
   a. ステータス更新が必要な請求を抽出
3. [ステータス判定]
   a. 引落予定日との日数差を計算
   b. 照合結果を確認
   c. 新しいステータスを決定
4. [更新処理]
   a. ステータスを更新
   b. 変更履歴を記録
   c. 必要に応じて通知生成
5. [ログ記録]
```

##### 手動ステータス更新
```
1. ユーザーが請求明細を選択
2. ステータス変更ボタンをクリック
3. ステータス選択ダイアログを表示
4. ユーザーがステータスとメモを入力
5. [検証] 遷移可能なステータスかチェック
6. [更新] ステータスと更新理由を保存
7. [通知] 成功メッセージを表示
```

#### データ構造

```typescript
interface PaymentStatusRecord {
  id: string;
  cardSummaryId: string;
  status: PaymentStatus;
  previousStatus?: PaymentStatus;
  updatedAt: Date;
  updatedBy: 'system' | 'user';
  reason?: string;
  reconciliationId?: string;
  notes?: string;
}

interface PaymentStatusHistory {
  recordId: string;
  statusChanges: PaymentStatusRecord[];
}
```

#### バリデーション
- ステータス遷移の妥当性チェック
- 必須項目の存在確認
- 権限チェック（手動更新時）

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| PS001 | 無効なステータス遷移 | 許可された遷移のみ実行 |
| PS002 | 請求データが見つからない | データを再取得 |
| PS003 | 更新権限がない | 管理者に問い合わせ |
| PS004 | 同時更新の競合 | 最新データを再取得して再試行 |

#### パフォーマンス要件
- ステータス更新: 50ms以内
- 一括更新（100件）: 3秒以内
- 履歴取得: 200ms以内

#### セキュリティ考慮事項
- 更新履歴の改ざん防止
- 権限ベースのアクセス制御

#### テストケース

##### TC-014-001: 自動ステータス更新（PENDING → PROCESSING）
- **前提**: 引落予定日が3日後の請求
- **実行**: 日次バッチ実行
- **期待結果**: ステータスがPROCESSINGに更新

##### TC-014-002: 照合成功時のステータス更新
- **前提**: PROCESSING状態の請求
- **入力**: 照合成功（FR-013）
- **期待結果**: ステータスがPAIDに更新

##### TC-014-003: 延滞検知
- **前提**: 引落予定日から8日経過、未払い
- **実行**: 日次バッチ実行
- **期待結果**: 
  - ステータスがOVERDUEに更新
  - 重要アラート生成

##### TC-014-004: 手動ステータス更新
- **前提**: DISPUTED状態の請求
- **入力**: ユーザーがMANUAL_CONFIRMEDに変更
- **期待結果**: 
  - ステータス更新
  - 履歴に記録
  - メモが保存される

##### TC-014-005: 無効な遷移の拒否
- **前提**: PAID状態の請求
- **入力**: PENDINGへの変更を試行
- **期待結果**: エラーメッセージ表示、更新されない

#### UI/UX要件
- ステータスのカラーコード表示
  - PENDING: 黄色
  - PROCESSING: 青色
  - PAID: 緑色
  - OVERDUE: 赤色
  - DISPUTED: オレンジ色
- ステータスバッジ
- ステータス変更履歴の表示
- フィルタ機能（ステータス別）
- 一括ステータス更新（チェックボックス選択）

#### 通知設定
- OVERDUE時: プッシュ通知 + メール
- DISPUTED時: アプリ内通知
- PAID時: バッジ更新のみ

#### 関連要件
- [FR-012: クレジットカード月別集計](#fr-012-クレジットカード月別集計)
- [FR-013: 銀行引落額との自動照合](#fr-013-銀行引落額との自動照合)
- [FR-015: 不一致時のアラート表示](#fr-015-不一致時のアラート表示)

#### 備考
- ステータス履歴は監査目的で永続保存
- Phase 6で分割払いのステータス管理を追加予定

---

## FR-015: 不一致時のアラート表示

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-015 |
| 機能名 | 照合不一致時のアラート表示 |
| 優先度 | 中 |
| 対応Phase | Phase 5 |

### 概要
クレジットカード請求額と銀行引落額に不一致が検出された場合、ユーザーに分かりやすくアラートを表示し、確認・対応を促す。

### 詳細仕様

#### アラートレベル定義

```typescript
enum AlertLevel {
  INFO = 'info',           // 情報（軽微な差異）
  WARNING = 'warning',     // 警告（要確認）
  ERROR = 'error',         // エラー（重大な不一致）
  CRITICAL = 'critical'    // 緊急（延滞等）
}
```

#### アラート種別

##### 1. 金額不一致アラート
- **レベル**: WARNING
- **条件**: カード請求額 ≠ 銀行引落額
- **情報**:
  - 請求額
  - 引落額
  - 差額
  - 考えられる原因

##### 2. 引落未検出アラート
- **レベル**: ERROR
- **条件**: 引落予定日+3日経過でも引落取引が見つからない
- **情報**:
  - 請求額
  - 予定引落日
  - 経過日数

##### 3. 延滞アラート
- **レベル**: CRITICAL
- **条件**: 引落予定日+7日経過でも未払い
- **情報**:
  - 未払い金額
  - 延滞日数
  - 対処方法

##### 4. 複数候補アラート
- **レベル**: INFO
- **条件**: 照合候補取引が複数存在
- **情報**:
  - 候補取引のリスト
  - 手動選択の促し

#### データ構造

```typescript
interface Alert {
  id: string;
  type: AlertType;
  level: AlertLevel;
  title: string;
  message: string;
  details: AlertDetails;
  createdAt: Date;
  isRead: boolean;
  isResolved: boolean;
  resolvedAt?: Date;
  resolvedBy?: string;
  resolutionNote?: string;
  actions: AlertAction[];
}

interface AlertDetails {
  cardId: string;
  cardName: string;
  billingMonth: string;
  expectedAmount: number;
  actualAmount?: number;
  discrepancy?: number;
  relatedTransactions: string[];
}

interface AlertAction {
  id: string;
  label: string;
  action: ActionType;
  isPrimary: boolean;
}

enum ActionType {
  VIEW_DETAILS = 'view_details',
  MANUAL_MATCH = 'manual_match',
  MARK_RESOLVED = 'mark_resolved',
  CONTACT_BANK = 'contact_bank',
  IGNORE = 'ignore'
}
```

#### 入力
- 照合結果（FR-013）
- ステータス情報（FR-014）
- 不一致詳細データ

#### 出力
- アラート通知
- アラート一覧
- 未読アラートカウント

#### 処理フロー

##### アラート生成
```
1. [トリガー] 照合処理完了（FR-013）
2. [判定]
   a. 照合結果を評価
   b. 不一致の種類を判定
   c. アラートレベルを決定
3. [生成]
   a. アラートオブジェクトを作成
   b. メッセージを構築
   c. 推奨アクションを設定
4. [保存]
   a. アラートをデータベースに保存
   b. 未読カウントを更新
5. [通知]
   a. UI上でポップアップ表示
   b. バッジカウント更新
   c. 必要に応じてプッシュ通知/メール
```

##### アラート表示
```
1. ユーザーがアプリを開く
2. [確認] 未読アラートの有無をチェック
3. [表示]
   - CRITICALアラート: 即座にモーダル表示
   - ERROR/WARNINGアラート: バッジ表示
   - INFOアラート: 一覧でのみ表示
4. [ユーザーアクション]
   a. アラートをクリック
   b. 詳細情報を表示
   c. アクションボタンを選択
5. [処理]
   a. 選択されたアクションを実行
   b. 既読マークを付ける
   c. 必要に応じて解決済みに変更
```

#### アラートメッセージテンプレート

##### 金額不一致
```
タイトル: クレジットカード引落額が一致しません

メッセージ:
{カード名}の{請求月}分の引落額に差異があります。

請求額: ¥{expected_amount}
引落額: ¥{actual_amount}
差額: ¥{discrepancy}

考えられる原因:
- ポイント利用が反映されていない
- 一部支払いの処理
- 請求額の訂正
- データ取得のタイミングずれ

アクション:
[詳細を確認] [手動で照合] [解決済みにする]
```

##### 引落未検出
```
タイトル: クレジットカードの引落が確認できません

メッセージ:
{カード名}の{請求月}分（¥{expected_amount}）の引落が
予定日から{days}日経過しても確認できません。

引落予定日: {payment_date}

アクション:
[銀行明細を確認] [手動で照合] [カード会社に問い合わせ]
```

##### 延滞
```
タイトル: 【重要】クレジットカードの支払いが遅延しています

メッセージ:
{カード名}の{請求月}分（¥{expected_amount}）の支払いが
{days}日遅延しています。

至急、以下をご確認ください:
1. 銀行口座の残高
2. カード会社からの連絡
3. 引落口座の設定

アクション:
[詳細を確認] [カード会社に連絡] [支払済みにする]
```

#### バリデーション
- アラートレベルの妥当性
- 必須情報の存在確認
- 重複アラートの防止

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| AL001 | アラート生成失敗 | ログ記録して再試行 |
| AL002 | 通知送信失敗 | バックグラウンドで再送 |
| AL003 | アラート解決失敗 | データを再読み込み |

#### パフォーマンス要件
- アラート生成: 100ms以内
- ポップアップ表示: 即座
- アラート一覧取得: 300ms以内

#### セキュリティ考慮事項
- 通知内容の個人情報保護
- アラート履歴の暗号化

#### テストケース

##### TC-015-001: 金額不一致アラート生成
- **前提**: カード請求50,000円、銀行引落48,000円
- **実行**: 照合処理実行
- **期待結果**:
  - WARNINGレベルのアラート生成
  - 差額-2,000円が表示される
  - 3つのアクションボタンが表示される

##### TC-015-002: 引落未検出アラート
- **前提**: 引落予定日から4日経過、引落なし
- **実行**: 日次バッチ実行
- **期待結果**:
  - ERRORレベルのアラート生成
  - 経過日数が表示される

##### TC-015-003: 延滞アラート
- **前提**: 引落予定日から8日経過、未払い
- **実行**: 日次バッチ実行
- **期待結果**:
  - CRITICALレベルのアラート生成
  - モーダルで即座に表示
  - プッシュ通知送信

##### TC-015-004: アラート解決
- **前提**: 未解決のWARNINGアラート
- **入力**: ユーザーが「解決済みにする」をクリック
- **期待結果**:
  - isResolvedがtrueに更新
  - アラート一覧から消える
  - 履歴に残る

##### TC-015-005: 重複アラート防止
- **前提**: 同じ請求に対するアラートが既に存在
- **実行**: 再度照合処理実行
- **期待結果**: 新しいアラートは生成されない

#### UI/UX要件

##### ポップアップデザイン
- レベル別のカラーテーマ
  - INFO: 青
  - WARNING: 黄
  - ERROR: オレンジ
  - CRITICAL: 赤
- アイコン表示
- アニメーション効果
- 自動閉じる（INFOのみ、5秒後）

##### アラート一覧
- レベル別フィルタ
- 未読/既読フィルタ
- 日付順ソート
- 検索機能
- 一括既読機能
- エクスポート機能

##### バッジ表示
- ヘッダーにアラートアイコン
- 未読件数の表示
- レベル別の色分け

#### 通知チャネル

| レベル | アプリ内 | ポップアップ | プッシュ | メール |
|--------|---------|------------|---------|--------|
| INFO | ○ | × | × | × |
| WARNING | ○ | ○ | × | × |
| ERROR | ○ | ○ | ○ | × |
| CRITICAL | ○ | ○ | ○ | ○ |

#### 通知設定のカスタマイズ
ユーザーが通知方法を設定可能:
- アラートレベル別のオン/オフ
- 通知チャネルの選択
- 通知時間帯の設定
- Do Not Disturb設定

#### 関連要件
- [FR-012: クレジットカード月別集計](#fr-012-クレジットカード月別集計)
- [FR-013: 銀行引落額との自動照合](#fr-013-銀行引落額との自動照合)
- [FR-014: 支払いステータス管理](#fr-014-支払いステータス管理)

#### 備考
- アラートの保持期間: 解決後90日
- 重要度の高いアラートは削除不可（アーカイブのみ）
- 統計情報の収集（アラート発生頻度等）

---

## 付録

### A. 用語集

| 用語 | 説明 |
|------|------|
| 照合 | クレジットカード請求額と銀行引落額を突き合わせること |
| 締め日 | クレジットカードの請求対象期間の最終日 |
| 引落日 | 銀行口座から実際に引き落とされる日 |
| 請求月 | クレジットカードの請求が発生する月 |
| 摘要 | 銀行取引明細の説明文 |
| ステータス | 支払いの進行状況を示す状態 |

### B. 参照ドキュメント

- [要件定義書](../requirements-specification.md)
- [FR-001-007: データ取得機能](FR-001-007_data-acquisition.md)
- [FR-008-011: データ分類機能](FR-008-011_data-classification.md)

### C. 変更履歴

| バージョン | 日付 | 変更内容 | 作成者 |
|-----------|------|---------|--------|
| 1.0 | 2025-11-15 | 初版作成 | System |

---

**文書管理**
- **承認者**: 未定
- **レビュー日**: 未定
- **次回レビュー予定**: Phase 5開始時
