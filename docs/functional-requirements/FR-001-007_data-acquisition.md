# 機能要件書：データ取得機能

**文書バージョン**: 1.0  
**作成日**: 2025-11-15  
**最終更新日**: 2025-11-15

## 目次
- [FR-001: 銀行口座との連携](#fr-001-銀行口座との連携)
- [FR-002: クレジットカードとの連携](#fr-002-クレジットカードとの連携)
- [FR-003: 証券会社との連携](#fr-003-証券会社との連携)
- [FR-004: バックグラウンド接続確認](#fr-004-バックグラウンド接続確認)
- [FR-005: 接続失敗通知](#fr-005-接続失敗通知)
- [FR-006: 利用履歴自動取得](#fr-006-利用履歴自動取得)
- [FR-007: データローカル保存](#fr-007-データローカル保存)

---

## FR-001: 銀行口座との連携

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-001 |
| 機能名 | 銀行口座との連携 |
| 優先度 | 高 |
| 対応Phase | Phase 3 |

### 概要
各銀行のAPIを使用して、口座情報と取引履歴を取得できるよう連携機能を実装する。

### 詳細仕様

#### 対応予定銀行
- メガバンク（三菱UFJ、三井住友、みずほ、りそな）
- 主要地方銀行
- ネット銀行（楽天銀行、住信SBIネット銀行、PayPay銀行等）

#### 取得可能な情報
- 口座基本情報
  - 銀行名
  - 支店名
  - 口座番号
  - 口座名義
  - 口座種別（普通、当座等）
- 口座残高
  - 現在残高
  - 利用可能残高
- 取引履歴
  - 取引日時
  - 取引種別（入金、出金、振込等）
  - 取引金額
  - 残高
  - 摘要・メモ

#### 入力
- 銀行選択
- 認証情報
  - 銀行コード
  - 支店コード
  - 口座番号
  - API認証キー/トークン
  - （銀行によって異なる認証方式に対応）

#### 出力
- 連携成功/失敗ステータス
- 取得した口座情報
- 取得した取引履歴データ
- エラーメッセージ（失敗時）

#### 処理フロー
```
1. ユーザーが設定画面から「銀行を追加」を選択
2. 対応銀行一覧を表示
3. ユーザーが銀行を選択
4. 認証情報入力フォームを表示
5. ユーザーが認証情報を入力
6. [検証] 入力値のバリデーション
7. [API接続] 銀行APIに接続テスト
8. [成功時]
   a. 認証情報を暗号化して保存
   b. 口座情報を取得
   c. 初回データ同期を実施
   d. 成功メッセージを表示
9. [失敗時]
   a. エラーメッセージを表示
   b. 再入力を促す
```

#### バリデーション
- 必須項目チェック
- 銀行コード形式チェック（4桁数字）
- 支店コード形式チェック（3桁数字）
- 口座番号形式チェック（7桁数字）
- APIキー形式チェック（各銀行の仕様に準拠）

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| BE001 | 認証情報が不正 | 入力内容を確認して再入力 |
| BE002 | API接続タイムアウト | しばらく待ってから再試行 |
| BE003 | 銀行API側エラー | 銀行のメンテナンス情報を確認 |
| BE004 | 対応していない銀行 | 対応銀行一覧を確認 |
| BE005 | APIレート制限超過 | 時間を置いて再試行 |

#### 画面要件
- 銀行選択画面
  - 検索機能（銀行名）
  - カテゴリ別表示（メガバンク、地方銀行、ネット銀行）
- 認証情報入力画面
  - 各項目のヘルプテキスト
  - 入力例の表示
  - パスワード表示/非表示切替
- 接続テスト進捗表示
  - ローディングインジケーター
  - 進行状況メッセージ

#### セキュリティ要件
- 認証情報は暗号化して保存
- 通信は必ずHTTPS使用
- トークン有効期限管理
- 再認証フロー実装

#### 依存関係
- FR-004（接続確認）に依存される
- FR-006（データ取得）の前提条件

---

## FR-002: クレジットカードとの連携

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-002 |
| 機能名 | クレジットカードとの連携 |
| 優先度 | 高 |
| 対応Phase | Phase 3 |

### 概要
各カード会社のAPIを使用して、クレジットカードの利用明細を取得できるよう連携機能を実装する。

### 詳細仕様

#### 対応予定カード会社
- 主要カード会社（JCB、VISA、Mastercard、AMEX）
- 銀行系カード
- 流通系カード（楽天、イオン等）
- 交通系カード（VIEW等）

#### 取得可能な情報
- カード基本情報
  - カード会社名
  - カード番号（下4桁）
  - カード名義
  - 有効期限
  - カードブランド
- 利用明細
  - 利用日
  - 利用店舗・サービス名
  - 利用金額
  - 決済状態（未確定、確定）
  - 引落予定日
  - カテゴリ（店舗が提供する場合）
- 請求情報
  - 当月請求額
  - 次回引落日
  - 引落口座

#### 入力
- カード会社選択
- 認証情報
  - カード番号
  - カード会員番号
  - Web明細ログインID/パスワード
  - API認証キー
  - （カード会社によって異なる）

#### 出力
- 連携成功/失敗ステータス
- 取得したカード情報
- 取得した利用明細データ
- 請求情報
- エラーメッセージ（失敗時）

#### 処理フロー
```
1. ユーザーが設定画面から「クレジットカードを追加」を選択
2. 対応カード会社一覧を表示
3. ユーザーがカード会社を選択
4. 認証情報入力フォームを表示
5. ユーザーが認証情報を入力
6. [検証] 入力値のバリデーション
7. [API接続] カード会社APIに接続テスト
8. [成功時]
   a. 認証情報を暗号化して保存
   b. カード情報を取得
   c. 利用明細を取得（過去3ヶ月分）
   d. 成功メッセージを表示
9. [失敗時]
   a. エラーメッセージを表示
   b. 再入力を促す
```

#### バリデーション
- 必須項目チェック
- カード番号形式チェック（Luhnアルゴリズム）
- 有効期限チェック（未来日付）
- メールアドレス形式チェック（通知用）

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| CC001 | 認証情報が不正 | カード情報を確認して再入力 |
| CC002 | API接続タイムアウト | しばらく待ってから再試行 |
| CC003 | カード会社API側エラー | メンテナンス情報を確認 |
| CC004 | 対応していないカード | 対応カード一覧を確認 |
| CC005 | カード有効期限切れ | カード情報を更新 |
| CC006 | 利用明細取得権限なし | Web明細サービスの登録確認 |

#### 画面要件
- カード会社選択画面
  - ブランド別表示
  - よく使われるカード会社を上位表示
- 認証情報入力画面
  - カード番号入力時のマスキング
  - 有効期限の入力補助
  - 各項目の詳細説明

#### セキュリティ要件
- PCIーDSS準拠
- カード番号は最後4桁のみ保持
- 完全なカード情報は保存しない
- トークン方式での認証

#### 依存関係
- FR-012（クレジットカード支払い管理）で使用
- FR-013（銀行引落との照合）で使用

---

## FR-003: 証券会社との連携

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-003 |
| 機能名 | 証券会社との連携 |
| 優先度 | 中 |
| 対応Phase | Phase 3 |

### 概要
証券会社のAPIを使用して、保有銘柄情報と取引履歴を取得できるよう連携機能を実装する。

### 詳細仕様

#### 対応予定証券会社
- ネット証券（SBI証券、楽天証券、マネックス証券等）
- 総合証券

#### 取得可能な情報
- 口座情報
  - 証券会社名
  - 口座番号
  - 口座種別（一般、特定、NISA等）
  - 評価額合計
  - 現金残高
- 保有銘柄情報
  - 銘柄コード
  - 銘柄名
  - 保有数量
  - 取得単価
  - 現在値
  - 評価損益
- 取引履歴
  - 取引日
  - 取引種別（買付、売却、配当、分配金等）
  - 銘柄
  - 数量
  - 単価
  - 金額
  - 手数料

#### 入力
- 証券会社選択
- 認証情報
  - ログインID
  - パスワード
  - 取引暗証番号（必要な場合）
  - API認証トークン

#### 出力
- 連携成功/失敗ステータス
- 口座情報
- 保有銘柄一覧
- 取引履歴データ
- エラーメッセージ（失敗時）

#### 処理フロー
```
1. ユーザーが設定画面から「証券口座を追加」を選択
2. 対応証券会社一覧を表示
3. ユーザーが証券会社を選択
4. 認証情報入力フォームを表示
5. ユーザーが認証情報を入力
6. [検証] 入力値のバリデーション
7. [API接続] 証券会社APIに接続テスト
8. [成功時]
   a. 認証情報を暗号化して保存
   b. 口座情報を取得
   c. 保有銘柄・取引履歴を取得
   d. 成功メッセージを表示
9. [失敗時]
   a. エラーメッセージを表示
   b. 再入力を促す
```

#### バリデーション
- 必須項目チェック
- 口座番号形式チェック
- パスワード強度チェック

#### エラー処理
| エラーコード | エラー内容 | 対処方法 |
|-------------|-----------|---------|
| SC001 | 認証情報が不正 | ログイン情報を確認 |
| SC002 | API接続タイムアウト | しばらく待ってから再試行 |
| SC003 | 証券会社API側エラー | メンテナンス情報を確認 |
| SC004 | 取引時間外 | 取引時間内に再試行 |
| SC005 | API利用権限なし | API利用申込を確認 |

#### 画面要件
- 証券会社選択画面
- 認証情報入力画面
- 口座種別選択（複数口座対応）

#### セキュリティ要件
- 認証情報の暗号化保存
- 取引暗証番号の厳重管理
- API権限の最小化（参照のみ）

#### 依存関係
- FR-008（カテゴリ分類）で投資カテゴリとして分類

---

## FR-004: バックグラウンド接続確認

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-004 |
| 機能名 | アプリ起動時のバックグラウンド接続確認 |
| 優先度 | 高 |
| 対応Phase | Phase 3 |

### 概要
アプリケーション起動時に、登録済みの全金融機関への接続状態をバックグラウンドで確認する。

### 詳細仕様

#### 確認タイミング
- アプリケーション起動時
- ユーザーが手動で「同期」ボタンを押した時
- 定期実行（設定で指定した間隔：デフォルト24時間）

#### 確認内容
- API接続可否
- 認証トークンの有効性
- データ取得可否

#### 入力
- 登録済み金融機関リスト
- 各金融機関の認証情報

#### 出力
- 各金融機関の接続ステータス
  - 接続成功（CONNECTED）
  - 接続失敗（DISCONNECTED）
  - 再認証必要（NEED_REAUTH）
  - 確認中（CHECKING）
- 最終接続確認日時
- エラー詳細（失敗時）

#### 処理フロー
```
1. [起動時トリガー] アプリケーション起動
2. [バックグラウンド実行開始]
3. 登録済み金融機関リストを取得
4. 各金融機関に対して並列処理:
   a. API接続テスト実行
   b. ステータスを更新
   c. タイムスタンプを記録
5. 全ての確認完了後
6. [失敗がある場合] FR-005（通知機能）をトリガー
7. UI上のステータス表示を更新
```

#### パフォーマンス要件
- 処理時間: 各金融機関あたり最大5秒
- タイムアウト: 10秒
- 並列処理: 最大5件同時実行
- UIブロックしない（非同期処理）

#### エラー処理
| ケース | 処理内容 |
|--------|---------|
| 1件のみ失敗 | ステータス更新、通知表示 |
| 複数失敗 | 一覧表示、個別エラー内容表示 |
| 全て失敗 | ネットワーク接続確認を促す |
| タイムアウト | 再試行可能な旨を通知 |

#### ログ出力
- 接続確認開始/終了ログ
- 各金融機関の接続結果ログ
- エラー詳細ログ（失敗時）

#### 画面要件
- ダッシュボードに接続ステータス表示
  - 緑: 正常接続
  - 黄: 最終接続から24時間以上経過
  - 赤: 接続失敗
- 最終確認時刻の表示
- 手動更新ボタン

#### 依存関係
- FR-001, FR-002, FR-003（各種連携）が前提
- FR-005（通知機能）をトリガー

---

## FR-005: 接続失敗通知

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-005 |
| 機能名 | 接続失敗時のポップアップ通知 |
| 優先度 | 高 |
| 対応Phase | Phase 4 |

### 概要
金融機関への接続が失敗した場合、ユーザーに適切な通知を行う。

### 詳細仕様

#### 通知トリガー
- FR-004の接続確認で失敗検出時
- データ取得処理中のエラー検出時
- トークン有効期限切れ検出時

#### 通知方法
- アプリ内ポップアップ通知
- ブラウザ通知（ユーザー許可時）
- ダッシュボード内のバナー表示

#### 入力
- エラー情報
  - 金融機関名
  - エラーコード
  - エラーメッセージ
  - 発生日時

#### 出力
- 通知メッセージ
- 推奨アクション
- 詳細情報へのリンク

#### 通知内容の例

**ケース1: 認証エラー**
```
【要対応】三菱UFJ銀行との接続に失敗しました

認証情報が無効になっている可能性があります。
設定画面から再度認証を行ってください。

[設定を開く] [後で]
```

**ケース2: API側エラー**
```
【情報】楽天カードのデータ取得ができませんでした

楽天カード側でメンテナンス中の可能性があります。
しばらく時間をおいてから再度お試しください。

[再試行] [閉じる]
```

**ケース3: 複数失敗**
```
【要確認】3件の金融機関で接続エラーが発生

以下の金融機関で接続に失敗しました：
- 三菱UFJ銀行
- 楽天カード
- SBI証券

[詳細を確認] [閉じる]
```

#### 処理フロー
```
1. [トリガー] 接続失敗検出
2. エラー内容を分析
3. エラー種別を判定
   - 認証エラー -> 要対応として通知
   - タイムアウト -> 情報として通知
   - API側エラー -> 情報として通知
4. 通知優先度を設定
5. 通知を表示
6. ユーザーアクションを待機
7. [ユーザーアクション]
   - 設定を開く -> 設定画面に遷移
   - 再試行 -> 再接続処理実行
   - 後で/閉じる -> 通知を閉じる
```

#### 通知優先度

| 優先度 | 表示方法 | 該当ケース |
|--------|---------|-----------|
| 高 | モーダルポップアップ | 認証エラー、複数失敗 |
| 中 | トースト通知 | API側エラー、タイムアウト |
| 低 | バナー表示のみ | 軽微なエラー |

#### 通知の重複防止
- 同一エラーは24時間に1回のみ通知
- ユーザーが「後で」を選択した場合、次回起動時まで非表示
- エラー解消後は通知を自動削除

#### 画面要件
- ポップアップデザイン
  - エラーレベルに応じた色分け
  - アイコン表示
  - 分かりやすいメッセージ
- 通知履歴画面
  - 過去の通知一覧
  - 対応状況の記録

#### ユーザビリティ要件
- 専門用語を避けた平易な表現
- 具体的な対処方法の提示
- ワンクリックで設定画面へ遷移可能

#### 依存関係
- FR-004（接続確認）からトリガーされる
- 設定画面への遷移機能

---

## FR-006: 利用履歴自動取得

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-006 |
| 機能名 | 各金融機関から利用履歴を自動取得 |
| 優先度 | 高 |
| 対応Phase | Phase 3 |

### 概要
連携済みの金融機関から定期的に取引履歴を自動取得し、システムに反映する。

### 詳細仕様

#### 取得タイミング
- アプリ起動時
- 定期実行（設定可能: デフォルト1日1回）
- 手動実行（同期ボタン押下時）

#### 取得期間
- 初回: 過去3ヶ月分
- 2回目以降: 前回取得日以降の差分

#### 入力
- 金融機関API接続情報
- 前回取得日時
- 取得期間指定

#### 出力
- 取得した取引データ
  - 取引ID（金融機関側）
  - 日付
  - 金額
  - 取引種別
  - 摘要/説明
  - 残高
- 取得件数
- 新規データ件数
- 重複データ件数

#### 処理フロー
```
1. [トリガー] 自動/手動実行開始
2. 連携済み金融機関リストを取得
3. 各金融機関に対して順次処理:
   a. 前回取得日時を確認
   b. API経由でデータ取得
   c. 取得データの重複チェック
   d. 新規データを一時保存
   e. カテゴリの自動分類（FR-008）
   f. データの正規化
4. 全金融機関の処理完了
5. データを永続化（FR-007）
6. UI更新通知
7. 取得結果サマリーを表示
```

#### 重複チェックロジック
- 金融機関ID + 取引日 + 金額 + 取引種別でユニーク判定
- 既存データと照合
- 重複の場合はスキップ

#### データ正規化
- 日付フォーマット統一（ISO 8601）
- 金額フォーマット統一（数値型）
- 取引種別の標準化
- 文字コード統一（UTF-8）

#### パフォーマンス要件
- 1000件/秒以上の処理速度
- メモリ使用量: 最大100MB
- バックグラウンド処理（UIブロックなし）

#### エラー処理
| エラー | 処理 |
|--------|------|
| API接続エラー | スキップして次の金融機関へ |
| データ形式エラー | ログ記録、該当データをスキップ |
| タイムアウト | リトライ（最大3回） |
| 認証エラー | FR-005で通知 |

#### ログ出力
```
[2025-11-15 10:00:00] データ取得開始
[2025-11-15 10:00:01] 三菱UFJ銀行: 取得中...
[2025-11-15 10:00:05] 三菱UFJ銀行: 15件取得（新規10件、重複5件）
[2025-11-15 10:00:06] 楽天カード: 取得中...
[2025-11-15 10:00:10] 楽天カード: 28件取得（新規28件、重複0件）
[2025-11-15 10:00:11] データ取得完了: 合計38件
```

#### 画面要件
- 同期進捗表示
  - プログレスバー
  - 現在処理中の金融機関名
  - 取得件数のリアルタイム表示
- 同期完了通知
  - トースト表示
  - 新規データ件数
  - 最終同期時刻

#### UI/UX要件
- バックグラウンド同期中も画面操作可能
- 同期状態の視覚的フィードバック
- 同期キャンセル機能

#### 依存関係
- FR-001~003（金融機関連携）が前提
- FR-007（ローカル保存）を呼び出す
- FR-008（カテゴリ分類）を呼び出す

---

## FR-007: データローカル保存

### 基本情報
| 項目 | 内容 |
|------|------|
| 機能ID | FR-007 |
| 機能名 | 取得データのローカル保存 |
| 優先度 | 高 |
| 対応Phase | Phase 2 |

### 概要
取得した取引データをJSON形式でローカルファイルシステムに保存する。

### 詳細仕様

#### 保存形式
- フォーマット: JSON
- エンコーディング: UTF-8
- 改行コード: LF

#### ディレクトリ構造
```
data/
├── transactions/
│   ├── 2025-11.json
│   ├── 2025-10.json
│   └── 2025-09.json
├── institutions/
│   └── institutions.json
├── accounts/
│   └── accounts.json
├── categories/
│   └── categories.json
└── settings/
    └── config.json
```

#### データスキーマ

**transactions/YYYY-MM.json**
```json
{
  "month": "2025-11",
  "transactions": [
    {
      "id": "uuid-v4",
      "externalId": "bank_trans_12345",
      "date": "2025-11-15T10:30:00Z",
      "amount": -3500,
      "category": "expense",
      "subcategory": "food",
      "description": "スーパーマーケット",
      "institutionId": "inst_001",
      "accountId": "acc_001",
      "balance": 150000,
      "status": "confirmed",
      "isReconciled": false,
      "createdAt": "2025-11-15T10:35:00Z",
      "updatedAt": "2025-11-15T10:35:00Z"
    }
  ],
  "summary": {
    "totalIncome": 250000,
    "totalExpense": 180000,
    "transactionCount": 45
  }
}
```

**institutions/institutions.json**
```json
{
  "institutions": [
    {
      "id": "inst_001",
      "name": "三菱UFJ銀行",
      "type": "bank",
      "isConnected": true,
      "lastSyncedAt": "2025-11-15T10:00:00Z",
      "createdAt": "2025-10-01T09:00:00Z"
    }
  ]
}
```

#### 入力
- 取引データオブジェクト
- 保存対象月（YYYY-MM）
- メタデータ

#### 出力
- 保存成功/失敗ステータス
- 保存ファイルパス
- エラーメッセージ（失敗時）

#### 処理フロー
```
1. [入力] 保存対象データ受領
2. データバリデーション
3. 保存対象月を特定
4. 既存ファイルの有無確認
5. [既存ファイルあり]
   a. 既存データを読み込み
   b. 新規データをマージ
   c. サマリーを再計算
6. [既存ファイルなし]
   a. 新規データ構造を作成
   b. サマリーを計算
7. JSONにシリアライズ
8. ファイルに書き込み
9. 書き込み検証
10. 成功/失敗を返却
```

#### バリデーション
- 必須フィールドの存在確認
- データ型の検証
- 日付フォーマットの検証
- 金額の妥当性チェック

#### エラー処理
| エラー | 処理 |
|--------|------|
| ディスク容量不足 | エラー通知、古いデータの圧縮提案 |
| 書き込み権限なし | 権限確認を促す |
| データ破損 | バックアップから復元 |
| JSON解析エラー | ログ記録、管理者通知 |

#### バックアップ戦略
- 書き込み前に既存ファイルをバックアップ
- バックアップ保持期間: 7日
- 自動バックアップディレクトリ: `data/backups/`

#### パフォーマンス最適化
- 月単位のファイル分割で読み込み高速化
- 大きなファイルは段階的読み込み
- インデックスファイルによる高速検索

#### データ整合性
- 書き込み時のトランザクション保証
- チェックサム計算と検証
- 定期的なデータ整合性チェック

#### 将来的なDB移行を考慮
- スキーマ設計をRDB互換に
- マイグレーションスクリプト用意
- IDフィールドはDB主キー互換

#### セキュリティ
- ファイルパーミッション設定（600）
- 機密情報の暗号化
- アクセスログ記録

#### 依存関係
- FR-006（データ取得）から呼び出される
- 全ての機能の基盤となる

---

## 補足事項

### テスト要件
各機能について以下のテストを実施する：
- 単体テスト
- 統合テスト
- API接続テスト（モック使用）
- エラーケーステスト

### モニタリング
- データ取得成功率
- API応答時間
- エラー発生頻度
- ディスク使用量

### 今後の拡張
- データエクスポート機能
- データインポート機能
- クラウド同期機能
- 複数デバイス対応
