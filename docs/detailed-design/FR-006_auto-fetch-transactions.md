# è©³ç´°è¨­è¨ˆæ›¸ï¼šFR-006 å„é‡‘èžæ©Ÿé–¢ã‹ã‚‰åˆ©ç”¨å±¥æ­´ã‚’è‡ªå‹•å–å¾—

**æ©Ÿèƒ½ID**: FR-006  
**æ©Ÿèƒ½å**: å„é‡‘èžæ©Ÿé–¢ã‹ã‚‰åˆ©ç”¨å±¥æ­´ã‚’è‡ªå‹•å–å¾—  
**ä½œæˆæ—¥**: 2025-11-22  
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-22  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Ÿè£…å®Œäº†

---

## ðŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ](#ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ)
3. [ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°](#ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°)
4. [APIä»•æ§˜](#apiä»•æ§˜)
5. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«)
6. [ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³](#ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³)
7. [ãƒ†ã‚¹ãƒˆæ–¹é‡](#ãƒ†ã‚¹ãƒˆæ–¹é‡)
8. [ä»Šå¾Œã®æ‹¡å¼µ](#ä»Šå¾Œã®æ‹¡å¼µ)

---

## æ¦‚è¦

### æ©Ÿèƒ½ç›®çš„

é€£æºæ¸ˆã¿ã®é‡‘èžæ©Ÿé–¢ï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã€è¨¼åˆ¸å£åº§ï¼‰ã‹ã‚‰å®šæœŸçš„ã«å–å¼•å±¥æ­´ã‚’è‡ªå‹•å–å¾—ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«åæ˜ ã™ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½

- **è‡ªå‹•åŒæœŸ**: 1æ—¥1å›žï¼ˆåˆå‰3æ™‚ï¼‰ã«è‡ªå‹•çš„ã«å®Ÿè¡Œ
- **æ‰‹å‹•åŒæœŸ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦æ‰‹å‹•ã§å®Ÿè¡Œ
- **å·®åˆ†åŒæœŸ**: å‰å›žåŒæœŸæ—¥æ™‚ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å–å¾—
- **åŒæœŸå±¥æ­´ç®¡ç†**: åŒæœŸã®å®Ÿè¡Œå±¥æ­´ã‚’è¨˜éŒ²
- **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: ä¸€éƒ¨ã®é‡‘èžæ©Ÿé–¢ãŒå¤±æ•—ã—ã¦ã‚‚ä»–ã¯ç¶™ç¶š

---

## ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       Presentation Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚  SyncController  â”‚  â† POST /sync, GET /sync/status      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Application Layer                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚     SyncTransactionsUseCase                   â”‚          â”‚
â”‚  â”‚  - åŒæœŸã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³                     â”‚          â”‚
â”‚  â”‚  - ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰/è¨¼åˆ¸å£åº§ã®çµ±åˆåŒæœŸ           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚    IncrementalSyncStrategy                    â”‚          â”‚
â”‚  â”‚  - å·®åˆ†åŒæœŸãƒ­ã‚¸ãƒƒã‚¯                            â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                            â”‚                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚      ScheduledSyncJob                         â”‚          â”‚
â”‚  â”‚  - Cronå®šæœŸå®Ÿè¡Œ (æ¯Žæ—¥åˆå‰3æ™‚)                  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Domain Layer                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚      SyncHistoryEntity                        â”‚          â”‚
â”‚  â”‚  - åŒæœŸå±¥æ­´ã®çŠ¶æ…‹ç®¡ç†                          â”‚          â”‚
â”‚  â”‚  - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ãƒ­ã‚¸ãƒƒã‚¯                       â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚      SyncStatus (Enum)                        â”‚          â”‚
â”‚  â”‚  - PENDING, IN_PROGRESS, SUCCESS, FAILED      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Infrastructure Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   SyncHistoryTypeOrmRepository                â”‚          â”‚
â”‚  â”‚  - sync_histories ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®æ°¸ç¶šåŒ–           â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

```
apps/backend/src/modules/sync/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ sync-history.entity.ts          # åŒæœŸå±¥æ­´ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â”‚   â””â”€â”€ sync-history.entity.spec.ts     # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ enums/
â”‚   â”‚   â””â”€â”€ sync-status.enum.ts             # åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ sync-history.repository.interface.ts  # ãƒªãƒã‚¸ãƒˆãƒªI/F
â”œâ”€â”€ application/
â”‚   â”œâ”€â”€ use-cases/
â”‚   â”‚   â”œâ”€â”€ sync-transactions.use-case.ts    # åŒæœŸå®Ÿè¡Œãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹
â”‚   â”‚   â””â”€â”€ sync-transactions.use-case.spec.ts
â”‚   â”œâ”€â”€ strategies/
â”‚   â”‚   â””â”€â”€ incremental-sync.strategy.ts     # å·®åˆ†åŒæœŸæˆ¦ç•¥
â”‚   â””â”€â”€ jobs/
â”‚       â””â”€â”€ scheduled-sync.job.ts            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
â”œâ”€â”€ infrastructure/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â””â”€â”€ sync-history.orm-entity.ts       # TypeORM ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ sync-history-typeorm.repository.ts  # ãƒªãƒã‚¸ãƒˆãƒªå®Ÿè£…
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ controllers/
â”‚   â”‚   â”œâ”€â”€ sync.controller.ts               # REST API ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
â”‚   â”‚   â””â”€â”€ sync.controller.spec.ts
â”‚   â””â”€â”€ dto/
â”‚       â””â”€â”€ sync.dto.ts                      # ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTO
â”œâ”€â”€ sync.module.ts                           # NestJSãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
â””â”€â”€ sync.tokens.ts                           # DIãƒˆãƒ¼ã‚¯ãƒ³
```

---

## ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°

### 1. SyncHistoryEntity (Domainå±¤)

**è²¬å‹™**: åŒæœŸå±¥æ­´ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†

**ä¸»è¦ãƒ¡ã‚½ãƒƒãƒ‰**:

- `create(totalInstitutions)`: æ–°è¦åŒæœŸå±¥æ­´ã‚’ä½œæˆ
- `start()`: åŒæœŸé–‹å§‹ï¼ˆPENDING â†’ IN_PROGRESSï¼‰
- `complete(success, failure, newTx)`: åŒæœŸå®Œäº†ï¼ˆSUCCESS/PARTIAL_SUCCESS/FAILEDï¼‰
- `fail(errorMessage, errorDetails)`: åŒæœŸå¤±æ•—
- `addNewTransactions(count)`: æ–°è¦å–å¼•æ•°ã‚’è¿½åŠ 

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»**:

```
PENDING â†’ IN_PROGRESS â†’ SUCCESS
                      â†’ PARTIAL_SUCCESS
                      â†’ FAILED
```

### 2. SyncTransactionsUseCase (Applicationå±¤)

**è²¬å‹™**: å…¨é‡‘èžæ©Ÿé–¢ã®åŒæœŸã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. æŽ¥ç¶šæ¸ˆã¿é‡‘èžæ©Ÿé–¢ã‚’å–å¾—ï¼ˆã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ + è¨¼åˆ¸å£åº§ï¼‰
2. åŒæœŸå±¥æ­´ã‚’ä½œæˆï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: PENDINGï¼‰
3. åŒæœŸé–‹å§‹ï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: IN_PROGRESSï¼‰
4. å„é‡‘èžæ©Ÿé–¢ã‚’é †æ¬¡åŒæœŸ:
   - ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: `RefreshCreditCardDataUseCase`ã‚’å‘¼ã³å‡ºã—
   - è¨¼åˆ¸å£åº§: `FetchSecurityTransactionsUseCase`ã‚’å‘¼ã³å‡ºã—
   - ã‚¨ãƒ©ãƒ¼æ™‚ã¯è¨˜éŒ²ã—ã¦æ¬¡ã¸ç¶™ç¶š
5. åŒæœŸå®Œäº†ï¼ˆæˆåŠŸ/å¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆã‚’é›†è¨ˆï¼‰
6. åŒæœŸå±¥æ­´ã‚’æ›´æ–°

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- å€‹åˆ¥é‡‘èžæ©Ÿé–¢ã®ã‚¨ãƒ©ãƒ¼ã¯è¨˜éŒ²ã™ã‚‹ãŒã€å…¨ä½“ã®åŒæœŸã¯ç¶™ç¶š
- å…¨é‡‘èžæ©Ÿé–¢ãŒå¤±æ•—ã—ãŸå ´åˆã®ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’FAILEDã«è¨­å®š

### 3. IncrementalSyncStrategy (Applicationå±¤)

**è²¬å‹™**: å·®åˆ†åŒæœŸæˆ¦ç•¥ã®å®Ÿè£…

**ãƒ­ã‚¸ãƒƒã‚¯**:

- å‰å›žåŒæœŸæ—¥æ™‚ï¼ˆ`lastSyncedAt`ï¼‰ã‹ã‚‰ç¾åœ¨ã¾ã§ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
- åˆå›žåŒæœŸæ™‚ã¯éŽåŽ»3ãƒ¶æœˆåˆ†ã‚’å–å¾—
- ä¸¦åˆ—å®Ÿè¡Œã‚‚ã‚µãƒãƒ¼ãƒˆï¼ˆ`executeParallel`ï¼‰

### 4. ScheduledSyncJob (Applicationå±¤)

**è²¬å‹™**: å®šæœŸå®Ÿè¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°

**ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**:

- Cronå¼: `0 0 3 * * *` (æ¯Žæ—¥åˆå‰3æ™‚)
- `@nestjs/schedule`ã®`@Cron`ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ä½¿ç”¨

**æŽ’ä»–åˆ¶å¾¡**:

- `isRunning`ãƒ•ãƒ©ã‚°ã§äºŒé‡å®Ÿè¡Œã‚’é˜²æ­¢
- å®Ÿè¡Œä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—

### 5. SyncController (Presentationå±¤)

**è²¬å‹™**: REST APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæä¾›

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:

- `POST /sync`: æ‰‹å‹•åŒæœŸå®Ÿè¡Œ
- `GET /sync/status`: ç¾åœ¨ã®åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
- `GET /sync/history`: åŒæœŸå±¥æ­´ä¸€è¦§å–å¾—
- `GET /sync/history/:id`: ç‰¹å®šã®åŒæœŸå±¥æ­´è©³ç´°å–å¾—

---

## APIä»•æ§˜

### POST /sync

æ‰‹å‹•ã§åŒæœŸã‚’å®Ÿè¡Œ

**Request Body**:

```json
{
  "forceFullSync": false // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: å…¨æœŸé–“åŒæœŸã™ã‚‹ã‹
}
```

**Response**:

```json
{
  "success": true,
  "data": {
    "syncId": "sync_1732262400_abc123",
    "status": "success",
    "successCount": 3,
    "failureCount": 0,
    "newTransactionsCount": 25,
    "startedAt": "2025-11-22T03:00:00Z",
    "completedAt": "2025-11-22T03:02:15Z"
  }
}
```

### GET /sync/status

ç¾åœ¨ã®åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—

**Response**:

```json
{
  "success": true,
  "data": {
    "isRunning": false,
    "latestSync": {
      "syncId": "sync_1732262400_abc123",
      "status": "success",
      "startedAt": "2025-11-22T03:00:00Z",
      "completedAt": "2025-11-22T03:02:15Z",
      "successCount": 3,
      "failureCount": 0,
      "newTransactionsCount": 25
    }
  }
}
```

### GET /sync/history

åŒæœŸå±¥æ­´ä¸€è¦§ã‚’å–å¾—

**Query Parameters**:

- `startDate` (optional): é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰
- `endDate` (optional): çµ‚äº†æ—¥æ™‚ï¼ˆISO 8601å½¢å¼ï¼‰

**Response**:

```json
{
  "success": true,
  "data": [
    {
      "syncId": "sync_1732262400_abc123",
      "status": "success",
      "startedAt": "2025-11-22T03:00:00Z",
      "completedAt": "2025-11-22T03:02:15Z",
      "totalInstitutions": 3,
      "successCount": 3,
      "failureCount": 0,
      "newTransactionsCount": 25,
      "errorMessage": null
    }
  ]
}
```

### GET /sync/history/:id

ç‰¹å®šã®åŒæœŸå±¥æ­´è©³ç´°ã‚’å–å¾—

**Response**:

```json
{
  "success": true,
  "data": {
    "syncId": "sync_1732262400_abc123",
    "status": "success",
    "startedAt": "2025-11-22T03:00:00Z",
    "completedAt": "2025-11-22T03:02:15Z",
    "totalInstitutions": 3,
    "successCount": 3,
    "failureCount": 0,
    "newTransactionsCount": 25,
    "errorMessage": null,
    "errorDetails": null
  }
}
```

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### sync_histories ãƒ†ãƒ¼ãƒ–ãƒ«

| ã‚«ãƒ©ãƒ å               | åž‹           | NULL | èª¬æ˜Ž               |
| ---------------------- | ------------ | ---- | ------------------ |
| id                     | VARCHAR(255) | NO   | åŒæœŸå±¥æ­´IDï¼ˆPKï¼‰   |
| status                 | ENUM         | NO   | åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹     |
| started_at             | TIMESTAMP    | NO   | åŒæœŸé–‹å§‹æ—¥æ™‚       |
| completed_at           | TIMESTAMP    | YES  | åŒæœŸå®Œäº†æ—¥æ™‚       |
| total_institutions     | INT          | NO   | åŒæœŸå¯¾è±¡é‡‘èžæ©Ÿé–¢æ•° |
| success_count          | INT          | NO   | æˆåŠŸæ•°             |
| failure_count          | INT          | NO   | å¤±æ•—æ•°             |
| new_transactions_count | INT          | NO   | æ–°è¦å–å¼•æ•°         |
| error_message          | TEXT         | YES  | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸   |
| error_details          | JSON         | YES  | ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆJSONï¼‰ |
| created_at             | TIMESTAMP    | NO   | ä½œæˆæ—¥æ™‚           |
| updated_at             | TIMESTAMP    | NO   | æ›´æ–°æ—¥æ™‚           |

**ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**:

- PRIMARY KEY: `id`
- INDEX: `started_at` (DESC) - æœ€æ–°å±¥æ­´å–å¾—ç”¨

---

## ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³

### å®šæœŸè‡ªå‹•åŒæœŸ

```
Cron            ScheduledSyncJob   SyncTransactionsUseCase  SyncHistoryRepository  CreditCard/Securities
 |                      |                      |                         |                |
 |--handleDailySync()-->|                      |                         |                |
 |                      |                      |                         |                |
 |                      |--execute()---------->|                         |                |
 |                      |                      |                         |                |
 |                      |                      |--create(syncHistory)--->|                |
 |                      |                      |<--syncHistory-----------|                |
 |                      |                      |                         |                |
 |                      |                      |--update(start)--------->|                |
 |                      |                      |<--syncHistory-----------|                |
 |                      |                      |                         |                |
 |                      |                      |--Get connected cards------------------->|
 |                      |                      |<--Cards list----------------------------|
 |                      |                      |                         |                |
 |                      |                      |--Sync each card------------------------>|
 |                      |                      |<--Sync result---------------------------|
 |                      |                      |                         |                |
 |                      |                      |--Get connected accts------------------->|
 |                      |                      |<--Accounts list-------------------------|
 |                      |                      |                         |                |
 |                      |                      |--Sync each account--------------------->|
 |                      |                      |<--Sync result---------------------------|
 |                      |                      |                         |                |
 |                      |                      |--update(complete)------>|                |
 |                      |                      |<--syncHistory-----------|                |
 |                      |                      |                         |                |
 |                      |<--Result-------------|                         |                |
 |                      |                      |                         |                |
 |<--Log completion-----|                      |                         |                |
```

### æ‰‹å‹•åŒæœŸ

```
User             SyncController      SyncTransactionsUseCase     SyncHistoryRepository
 |                      |                      |                         |
 |--POST /sync--------->|                      |                         |
 |                      |                      |                         |
 |                      |--execute()---------->|                         |
 |                      |                      |                         |
 |                      |                      |--create(syncHistory)--->|
 |                      |                      |<--syncHistory-----------|
 |                      |                      |                         |
 |                      |                      |-- [Sync process] ------>|
 |                      |                      |                         |
 |                      |                      |--update(syncHistory)--->|
 |                      |                      |<--syncHistory-----------|
 |                      |                      |                         |
 |                      |<--result-------------|                         |
 |                      |                      |                         |
 |<--Response-----------|                      |                         |
```

---

## ãƒ†ã‚¹ãƒˆæ–¹é‡

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**å¯¾è±¡**:

- `SyncHistoryEntity`: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ãƒ­ã‚¸ãƒƒã‚¯
- `SyncTransactionsUseCase`: åŒæœŸã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- `SyncController`: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**ã‚«ãƒãƒ¬ãƒƒã‚¸ç›®æ¨™**: 80%ä»¥ä¸Š

**ä¸»è¦ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:

1. æ­£å¸¸ç³»: å…¨é‡‘èžæ©Ÿé–¢ãŒæˆåŠŸ
2. éƒ¨åˆ†å¤±æ•—: ä¸€éƒ¨ãŒå¤±æ•—ã—ã¦ã‚‚PARTIAL_SUCCESS
3. å…¨å¤±æ•—: å…¨é‡‘èžæ©Ÿé–¢ãŒå¤±æ•—ã—ã¦FAILED
4. ç©ºçŠ¶æ…‹: æŽ¥ç¶šæ¸ˆã¿é‡‘èžæ©Ÿé–¢ãŒ0ä»¶
5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°: å„ç¨®ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹

### çµ±åˆãƒ†ã‚¹ãƒˆ

**å¯¾è±¡**:

- API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆE2Eãƒ†ã‚¹ãƒˆï¼‰
- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ

**ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ª**:

1. æ‰‹å‹•åŒæœŸãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã‚‹
2. åŒæœŸã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒæ­£ã—ãå–å¾—ã§ãã‚‹
3. åŒæœŸå±¥æ­´ãŒè¨˜éŒ²ã•ã‚Œã‚‹
4. é‡è¤‡å®Ÿè¡ŒãŒé˜²æ­¢ã•ã‚Œã‚‹

---

## ä»Šå¾Œã®æ‹¡å¼µ

### Phase 2: éŠ€è¡Œå£åº§å¯¾å¿œ

- éŠ€è¡ŒAPIé€£æºã®è¿½åŠ 
- `SyncTransactionsUseCase`ã«éŠ€è¡ŒåŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 

### Phase 3: ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½

- å¤±æ•—ã—ãŸé‡‘èžæ©Ÿé–¢ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
- ã‚¨ã‚¯ã‚¹ãƒãƒãƒ³ã‚·ãƒ£ãƒ«ãƒãƒƒã‚¯ã‚ªãƒ•ã®å®Ÿè£…

### Phase 4: é€šçŸ¥æ©Ÿèƒ½

- åŒæœŸå®Œäº†/å¤±æ•—ã®é€šçŸ¥
- EventEmitterçµŒç”±ã§é€šçŸ¥ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¨é€£æº

### Phase 5: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–

- ä¸¦åˆ—åŒæœŸã®å®Ÿè£…ï¼ˆç¾åœ¨ã¯é †æ¬¡å®Ÿè¡Œï¼‰
- å¤§é‡ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã®æœ€é©åŒ–

### Phase 6: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£å¯¾å¿œ

- **åˆ†æ•£ãƒ­ãƒƒã‚¯ãƒ¡ã‚«ãƒ‹ã‚ºãƒ ã®å°Žå…¥**
  - ç¾çŠ¶: ãƒ¡ãƒ¢ãƒªå†…ãƒ•ãƒ©ã‚°ï¼ˆ`isRunning`ï¼‰ã«ã‚ˆã‚‹å˜ä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ã§ã®æŽ’ä»–åˆ¶å¾¡
  - èª²é¡Œ: è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç’°å¢ƒã§ã¯ã€å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒç‹¬è‡ªã®ãƒ•ãƒ©ã‚°ã‚’æŒã¤ãŸã‚ã€åŒæœŸã‚¸ãƒ§ãƒ–ãŒé‡è¤‡å®Ÿè¡Œã•ã‚Œã‚‹å¯èƒ½æ€§
  - è§£æ±ºç­–:
    - Redisã‚’åˆ©ç”¨ã—ãŸåˆ†æ•£ãƒ­ãƒƒã‚¯ï¼ˆ`redlock`ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãªã©ï¼‰
    - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¡Œãƒ­ãƒƒã‚¯ã‚’åˆ©ç”¨
    - ç’°å¢ƒå¤‰æ•°ã§å˜ä¸€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹/è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ã™ã‚‹

### Phase 7: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„

- **IncrementalSyncStrategyã®å®Œå…¨æ´»ç”¨**
  - ç¾çŠ¶: `SyncTransactionsUseCase`ãŒå„é‡‘èžæ©Ÿé–¢ç”¨ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ï¼ˆ`refreshCreditCardDataUseCase`ã€`fetchSecurityTransactionsUseCase`ï¼‰ã‚’ç›´æŽ¥å‘¼ã³å‡ºã—ã¦ã„ã‚‹
  - èª²é¡Œ: åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ãŒåˆ†æ•£ã—ã€`IncrementalSyncStrategy`ãŒã‚¤ãƒ³ã‚¸ã‚§ã‚¯ãƒˆã•ã‚Œã¦ã„ã‚‹ãŒå®Ÿéš›ã«ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„
  - è§£æ±ºç­–:
    - `IFinancialInstitutionSync`ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©
    - ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰/è¨¼åˆ¸å£åº§ã®åŒæœŸãƒ­ã‚¸ãƒƒã‚¯ã‚’ã‚¢ãƒ€ãƒ—ã‚¿ãƒ¼ã‚¯ãƒ©ã‚¹ã«ãƒ©ãƒƒãƒ—
    - `IncrementalSyncStrategy`ã‚’ä»‹ã—ã¦çµ±ä¸€çš„ã«åŒæœŸå‡¦ç†ã‚’å®Ÿè¡Œ
    - ã“ã‚Œã«ã‚ˆã‚Šã€é–¢å¿ƒã®åˆ†é›¢ã¨å†åˆ©ç”¨æ€§ãŒå‘ä¸Š

---

## å®Ÿè£…å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] Domainå±¤: SyncHistory Entity / SyncStatus Enum
- [x] Applicationå±¤: SyncTransactionsUseCase
- [x] Applicationå±¤: IncrementalSyncStrategy
- [x] Applicationå±¤: ScheduledSyncJob
- [x] Infrastructureå±¤: SyncHistory Repository
- [x] Presentationå±¤: Sync Controller
- [x] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆ
- [x] Lintã‚¨ãƒ©ãƒ¼è§£æ¶ˆ
- [x] è©³ç´°è¨­è¨ˆæ›¸ä½œæˆ

---

## å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `docs/functional-requirements/FR-001-007_data-acquisition.md`
- `docs/system-architecture.md`
- `.cursor/rules/01-project.md` - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- `.cursor/rules/02-code-standards.md` - ã‚³ãƒ¼ãƒ‰å“è³ªåŸºæº–
