# FR-006 æœªå®Ÿè£…æ©Ÿèƒ½ãƒªã‚¹ãƒˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€FR-006ã®åˆæœŸå®Ÿè£…ï¼ˆIssue #28, PR #278ï¼‰ã§æœªå®Ÿè£…ã¨ãªã£ãŸæ©Ÿèƒ½ã‚’ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™ã€‚

---

## ğŸ”´ Critical: é‡‘èæ©Ÿé–¢APIé€£æº

### æ¦‚è¦

`SyncAllTransactionsUseCase.syncOne()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€å®Ÿéš›ã®é‡‘èæ©Ÿé–¢APIã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯ãŒæœªå®Ÿè£…ã§ã™ã€‚

### ç¾çŠ¶

- ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã§å‡¦ç†ï¼ˆæ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰=10ä»¶å›ºå®šï¼‰
- `TODO`ã‚³ãƒ¡ãƒ³ãƒˆ: `// TODO: ã“ã“ã§å®Ÿéš›ã®é‡‘èæ©Ÿé–¢APIã‹ã‚‰å–å¼•ã‚’å–å¾—`

### å®Ÿè£…ã«å¿…è¦ãªæ©Ÿèƒ½

- FR-001: éŠ€è¡Œå£åº§é€£æºï¼ˆæœªå®Ÿè£…ï¼‰
- FR-002: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é€£æºï¼ˆæœªå®Ÿè£…ï¼‰
- FR-003: è¨¼åˆ¸ä¼šç¤¾é€£æºï¼ˆæœªå®Ÿè£…ï¼‰

### å¯¾å¿œæ–¹é‡

- å„é‡‘èæ©Ÿé–¢é€£æºæ©Ÿèƒ½ã®å®Ÿè£…å¾Œã«å¯¾å¿œ
- åˆ¥Issue/PRã§å®Ÿè£…äºˆå®š

### å®Ÿè£…ä¾‹ï¼ˆå°†æ¥ï¼‰

```typescript
// institutionTypeã«å¿œã˜ã¦é©åˆ‡ãªUseCaseã‚’å‘¼ã³å‡ºã™
switch (target.institutionType) {
  case 'bank':
    transactions = await this.fetchBankTransactionsUseCase.execute({...});
    break;
  case 'credit-card':
    transactions = await this.fetchCreditCardTransactionsUseCase.execute({...});
    break;
  case 'securities':
    transactions = await this.fetchSecurityTransactionsUseCase.execute({...});
    break;
}
```

---

## ğŸŸ  High: åŒæœŸã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†

### æ¦‚è¦

`CancelSyncUseCase`ã§ã€å®Ÿè¡Œä¸­ã®éåŒæœŸå‡¦ç†ã‚’å®Ÿéš›ã«åœæ­¢ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ãŒæœªå®Ÿè£…ã§ã™ã€‚

### ç¾çŠ¶

- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’`CANCELLED`ã«æ›´æ–°ã™ã‚‹ã®ã¿
- å®Ÿè¡Œä¸­ã®å‡¦ç†ã¯ç¶™ç¶šã—ã¦ã—ã¾ã†

### Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜

> `AbortController`ãªã©ã‚’ç”¨ã„ã¦ã€é€²è¡Œä¸­ã®éåŒæœŸå‡¦ç†ã‚’ä¸­æ–­ã™ã‚‹ä»•çµ„ã¿ã‚’å°å…¥ã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™ã€‚

### å®Ÿè£…æ¡ˆ

1. **AbortControllerã®å°å…¥**

   ```typescript
   private syncAbortControllers = new Map<string, AbortController>();

   async syncOne(target: SyncTarget) {
     const abortController = new AbortController();
     this.syncAbortControllers.set(syncHistory.id, abortController);

     try {
       // signal ã‚’ APIå‘¼ã³å‡ºã—ã«æ¸¡ã™
       await fetchAPI({ signal: abortController.signal });
     } finally {
       this.syncAbortControllers.delete(syncHistory.id);
     }
   }

   async cancel(syncId: string) {
     const controller = this.syncAbortControllers.get(syncId);
     if (controller) {
       controller.abort();
     }
   }
   ```

2. **Queue/Job ã‚·ã‚¹ãƒ†ãƒ ã®æ´»ç”¨**
   - BullMQãªã©ã®ã‚¸ãƒ§ãƒ–ã‚­ãƒ¥ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹å ´åˆã€ã‚¸ãƒ§ãƒ–ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«APIã‚’æ´»ç”¨

### å¯¾å¿œæ–¹é‡

- é‡‘èæ©Ÿé–¢APIé€£æºå®Ÿè£…æ™‚ã«åˆã‚ã›ã¦å¯¾å¿œ
- åˆ¥Issue/PRã§å®Ÿè£…äºˆå®š

---

## ğŸŸ¡ Medium: å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°

### æ¦‚è¦

`ScheduledSyncJob.updateSchedule()`ãƒ¡ã‚½ãƒƒãƒ‰ã§ã€å®Ÿè¡Œä¸­ã®cronã‚¸ãƒ§ãƒ–ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‹•çš„ã«å¤‰æ›´ã™ã‚‹æ©Ÿèƒ½ãŒæœªå®Ÿè£…ã§ã™ã€‚

### ç¾çŠ¶

- `currentSchedule`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ›´æ–°ã™ã‚‹ã®ã¿
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•ãŒå¿…è¦
- `TODO`ã‚³ãƒ¡ãƒ³ãƒˆ: `// TODO: å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°ã®å®Ÿè£…`

### Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜

> `SchedulerRegistry`ã‚’ä½¿ç”¨ã—ã¦å‹•çš„ã«ã‚¸ãƒ§ãƒ–ã‚’å†ç™»éŒ²ã™ã‚‹å®Ÿè£…ã‚’æ¨å¥¨ã—ã¾ã™ã€‚ã‚‚ã—ã“ã®PRã§å®Ÿè£…ã—ãªã„å ´åˆã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰åã‚’`setNextScheduleOnRestart`ã®ã‚ˆã†ã«ã€å†èµ·å‹•å¾Œã«é©ç”¨ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‹ã‚‹åå‰ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚

### å®Ÿè£…æ¡ˆ

```typescript
import { SchedulerRegistry } from '@nestjs/schedule';
import { CronJob } from 'cron';

updateSchedule(cronExpression: string, timezone?: string): void {
  this.currentSchedule = cronExpression;
  if (timezone) {
    this.timezone = timezone;
  }

  // æ—¢å­˜ã®ã‚¸ãƒ§ãƒ–ã‚’å‰Šé™¤
  const jobName = 'scheduled-sync';
  const existingJob = this.schedulerRegistry.getCronJob(jobName);
  if (existingJob) {
    existingJob.stop();
    this.schedulerRegistry.deleteCronJob(jobName);
  }

  // æ–°ã—ã„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã‚¸ãƒ§ãƒ–ã‚’å†ç™»éŒ²
  const job = new CronJob(
    this.currentSchedule,
    () => { void this.handleCron(); },
    null,
    this.enabled,
    this.timezone,
  );
  this.schedulerRegistry.addCronJob(jobName, job);
  job.start();

  this.logger.log(`ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‹•çš„ã«æ›´æ–°ã—ã¾ã—ãŸ: ${cronExpression}`);
}
```

### å¯¾å¿œæ–¹é‡

- åˆ¥Issue/PRã§å®Ÿè£…äºˆå®š
- ã¾ãŸã¯ã€ãƒ¡ã‚½ãƒƒãƒ‰åã‚’`setNextScheduleOnRestart()`ã«å¤‰æ›´ã—ã¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆåŒ–

---

## ğŸŸ¡ Medium: åŒæœŸé€²æ—ã®è¨ˆç®—

### æ¦‚è¦

`GetSyncStatusUseCase`ã§ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã®é€²æ—æƒ…å ±ã®è¨ˆç®—ãŒãƒ¢ãƒƒã‚¯å®Ÿè£…ã«ãªã£ã¦ã„ã¾ã™ã€‚

### ç¾çŠ¶

- å›ºå®šå€¤ï¼ˆtotalInstitutions: 5, completedInstitutions: 2, percentage: 40ï¼‰ã‚’è¿”ã™
- `TODO`ã‚³ãƒ¡ãƒ³ãƒˆ: `// TODO: é€²æ—æƒ…å ±ã®è¨ˆç®—ï¼ˆç¾åœ¨ã¯ãƒ¢ãƒƒã‚¯ï¼‰`

### Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜

> ã“ã®ã¾ã¾ã§ã¯ã€APIã¯å¸¸ã«å›ºå®šã®é€²æ—(`40%`)ã‚’è¿”ã—ã¦ã—ã¾ã„ã¾ã™ã€‚å®Ÿéš›ã®é€²æ—ã‚’è¨ˆç®—ãƒ»å–å¾—ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

### å®Ÿè£…æ¡ˆ

1. **å…±æœ‰çŠ¶æ…‹ç®¡ç†**

   ```typescript
   // sync.module.ts ã« SharedStateService ã‚’è¿½åŠ 
   @Injectable()
   export class SyncProgressService {
     private currentProgress = new Map<string, SyncProgress>();

     setProgress(syncId: string, progress: SyncProgress) { ... }
     getProgress(syncId: string): SyncProgress | null { ... }
   }

   // SyncAllTransactionsUseCase ã§ä½¿ç”¨
   async syncInParallel(...) {
     for (let i = 0; i < targets.length; i += this.MAX_PARALLEL) {
       this.progressService.setProgress(syncHistory.id, {
         total: targets.length,
         completed: i,
         current: targets[i].institutionName,
       });
       // ... åŒæœŸå‡¦ç†
     }
   }
   ```

2. **Redis/Cacheã‚’æ´»ç”¨**
   - åˆ†æ•£ç’°å¢ƒã§ã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã€Redisã§é€²æ—ã‚’ç®¡ç†

### å¯¾å¿œæ–¹é‡

- åˆ¥Issue/PRã§å®Ÿè£…äºˆå®š

---

## ğŸŸ¡ Medium: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«APIï¼ˆãƒ¢ãƒƒã‚¯å®Ÿè£…ï¼‰

### æ¦‚è¦

`SyncController.getSyncSchedule()`ã¨`updateSyncSchedule()`ãŒãƒ¢ãƒƒã‚¯å®Ÿè£…ã§ã™ã€‚

### ç¾çŠ¶

- å›ºå®šå€¤ã‚’è¿”ã™ã®ã¿
- `TODO`ã‚³ãƒ¡ãƒ³ãƒˆ: `// TODO: ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç®¡ç†ã®å®Ÿè£…`

### Geminiãƒ¬ãƒ“ãƒ¥ãƒ¼æŒ‡æ‘˜

> APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ã—ã¦ã¯å­˜åœ¨ã—ã¾ã™ãŒã€å®Ÿéš›ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å–å¾—ã‚„æ›´æ–°ã¯è¡Œã‚ã‚Œã¾ã›ã‚“ã€‚ã“ã®ã¾ã¾ã§ã¯APIä»•æ§˜ã¨å®Ÿè£…ãŒä¹–é›¢ã—ã¦ã„ã¾ã™ã€‚

### å®Ÿè£…æ¡ˆ

```typescript
// Controller
@Get('schedule')
async getSyncSchedule(): Promise<SyncScheduleResponseDto> {
  const schedule = await this.scheduledSyncJob.getSchedule();
  return {
    success: true,
    data: {
      enabled: schedule.enabled,
      cronExpression: schedule.cronExpression,
      timezone: schedule.timezone,
      nextRun: schedule.nextRun?.toISOString() || null,
    },
  };
}

@Put('schedule')
async updateSyncSchedule(@Body() dto: UpdateSyncScheduleRequestDto) {
  await this.scheduledSyncJob.updateSchedule(
    dto.cronExpression,
    dto.timezone,
  );
  await this.scheduledSyncJob.setEnabled(dto.enabled);
  return this.getSyncSchedule();
}
```

### å¯¾å¿œæ–¹é‡

- å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°æ©Ÿèƒ½ã¨åˆã‚ã›ã¦å®Ÿè£…
- ã¾ãŸã¯ã€ä¸€æ™‚çš„ã«ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

---

## ğŸ“‹ å®Ÿè£…å„ªå…ˆåº¦ã¨ä¾å­˜é–¢ä¿‚

### Phase 1: åŸºç›¤æ©Ÿèƒ½ï¼ˆç¾åœ¨ã®PR #278ï¼‰

- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ
- âœ… APIè¨­è¨ˆ
- âœ… åŸºæœ¬çš„ãªåŒæœŸãƒ•ãƒ­ãƒ¼
- âœ… åŒæœŸå±¥æ­´ã®ç®¡ç†

### Phase 2: é‡‘èæ©Ÿé–¢é€£æºï¼ˆåˆ¥Issueï¼‰

- ğŸ”´ FR-001: éŠ€è¡Œå£åº§é€£æº
- ğŸ”´ FR-002: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰é€£æº
- ğŸ”´ FR-003: è¨¼åˆ¸ä¼šç¤¾é€£æº
- ğŸŸ  å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- ğŸŸ  åŒæœŸã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†å®Ÿè£…

### Phase 3: é‹ç”¨æ©Ÿèƒ½å¼·åŒ–ï¼ˆåˆ¥Issueï¼‰

- ğŸŸ¡ å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æ›´æ–°
- ğŸŸ¡ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—è¡¨ç¤º
- ğŸŸ¡ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«APIå®Ÿè£…
- ğŸŸ¡ é€šçŸ¥æ©Ÿèƒ½ã®å®Ÿè£…
- ğŸŸ¡ ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†ã®æ‹¡å¼µ

---

## ğŸ”— é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [è©³ç´°è¨­è¨ˆæ›¸: FR-006 README](./README.md)
- [ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³](./sequence-diagrams.md)
- [APIä»•æ§˜](./input-output-design.md)
- [ãƒãƒƒãƒå‡¦ç†ä»•æ§˜](./batch-processing.md)

---

**æœ€çµ‚æ›´æ–°**: 2025-11-23
**é–¢é€£Issue**: #28
**é–¢é€£PR**: #278
