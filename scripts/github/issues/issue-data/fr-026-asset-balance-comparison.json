{
  "title": "[enhancement] FR-026: 資産残高の前月比・前年比計算ロジックの実装",
  "labels": ["enhancement", "priority: medium", "size: M", "backend"],
  "body": "## 概要\n\nFR-026（金融機関別資産残高表示）の実装において、前月比・前年比の計算ロジックは現時点では0を返す実装となっています。履歴データを活用して、正確な前月同日・前年同日の残高を計算し、増減額と増減率を表示できるようにします。\n\n## 背景\n\n### 現状\n\nFR-026の実装（Issue #73）では、資産残高表示機能の基本実装を完了しましたが、前月比・前年比の計算は以下の理由で将来対応としています：\n\n- 口座残高の履歴データが保存されていない\n- 前月同日・前年同日の時点での残高を取得する方法がない\n- 取引データから逆算する必要があるが、初期残高が不明\n\n**現在の実装**:\n\n```typescript\n// apps/backend/src/modules/transaction/application/use-cases/calculate-asset-balance.use-case.ts\n// 前月比・前年比を計算（将来対応: 履歴データから取得）\n// 現時点では0で返す\nconst previousMonth: AssetComparisonDto = {\n  diff: 0,\n  rate: 0,\n};\nconst previousYear: AssetComparisonDto = {\n  diff: 0,\n  rate: 0,\n};\n```\n\n### 目指す姿\n\n- 前月同日の残高を取得して、現在の残高との増減額・増減率を計算\n- 前年同日の残高を取得して、現在の残高との増減額・増減率を計算\n- フロントエンドで前月比・前年比を視覚的に表示\n\n## 実装方針\n\n### アプローチ1: 残高履歴テーブルの作成（推奨）\n\n口座残高の履歴を保存するテーブルを作成し、定期的にスナップショットを保存します。\n\n**メリット**:\n- 正確な残高を取得できる\n- パフォーマンスが良い（直接クエリで取得可能）\n- 過去の任意の時点の残高を取得可能\n\n**デメリット**:\n- データベーススキーマの変更が必要\n- スナップショット保存のバッチ処理が必要\n\n**実装内容**:\n1. `account_balance_history`テーブルの作成\n2. 日次バッチ処理で残高スナップショットを保存\n3. UseCaseで履歴テーブルから前月同日・前年同日の残高を取得\n4. 増減額・増減率を計算\n\n### アプローチ2: 取引データから逆算（代替案）\n\n取引データから前月同日・前年同日の残高を逆算します。\n\n**メリット**:\n- 既存のデータで実装可能\n- スキーマ変更が不要\n\n**デメリット**:\n- 初期残高が不明な場合、正確な計算が困難\n- 計算処理が複雑\n- パフォーマンスが劣る可能性\n\n**実装内容**:\n1. 基準日までのすべての取引を取得\n2. 口座ごとに残高を計算（初期残高 + 取引の累積）\n3. 前月同日・前年同日の残高を計算\n4. 増減額・増減率を計算\n\n## 作業内容\n\n### Phase 1: データモデル設計・実装（アプローチ1の場合）\n\n- [ ] `account_balance_history`テーブルの設計\n  - [ ] スキーマ定義（account_id, balance, as_of_date, created_at等）\n  - [ ] マイグレーションファイル作成\n- [ ] 残高履歴エンティティの作成\n  - [ ] Domain Entity\n  - [ ] ORM Entity\n  - [ ] Repository Interface & Implementation\n\n### Phase 2: バッチ処理の実装（アプローチ1の場合）\n\n- [ ] 日次バッチ処理の実装\n  - [ ] すべての口座の残高を取得\n  - [ ] 履歴テーブルに保存\n  - [ ] エラーハンドリング\n- [ ] バッチ処理のスケジューリング\n  - [ ] Cron設定（例: 毎日0時）\n  - [ ] 実行ログの記録\n\n### Phase 3: UseCaseの実装\n\n- [ ] 前月同日の残高取得ロジック\n  - [ ] 日付計算（閏年対応）\n  - [ ] 履歴テーブルから取得（アプローチ1）または取引データから計算（アプローチ2）\n- [ ] 前年同日の残高取得ロジック\n  - [ ] 日付計算\n  - [ ] 履歴テーブルから取得（アプローチ1）または取引データから計算（アプローチ2）\n- [ ] 増減額・増減率の計算\n  - [ ] `AssetBalanceDomainService`にメソッド追加\n  - [ ] 計算ロジックの実装\n- [ ] `CalculateAssetBalanceUseCase`の修正\n  - [ ] 前月比・前年比の計算を実装\n  - [ ] エラーハンドリング（履歴データが存在しない場合）\n\n### Phase 4: テスト\n\n- [ ] ユニットテスト\n  - [ ] Domain Serviceのテスト\n  - [ ] UseCaseのテスト\n  - [ ] 日付計算のエッジケース（閏年、月末等）\n- [ ] 統合テスト\n  - [ ] APIエンドポイントのテスト\n  - [ ] 履歴データ取得のテスト\n- [ ] E2Eテスト\n  - [ ] フロントエンドでの表示確認\n\n## 技術的な詳細\n\n### 日付計算の考慮事項\n\n- **閏年対応**: 2月29日の前月同日は1月29日、前年同日は前年の2月最終日\n- **月末の処理**: 前月同日が存在しない場合（例: 3月31日の前月同日は2月28日または29日）\n- **タイムゾーン**: UTC基準で統一\n\n### エラーハンドリング\n\n- 履歴データが存在しない場合: 0を返す（現状と同じ挙動）\n- データ取得エラー: ログを記録し、0を返す\n- 計算エラー: 例外をスローせず、0を返す（UIの表示を優先）\n\n## 関連Issue\n\n- Issue #73: FR-026 金融機関別資産残高表示（基本実装）\n- PR #382: FR-026の詳細設計書\n\n## 参考資料\n\n- [詳細設計書: FR-026](../../docs/detailed-design/FR-026_institution-asset-balance/README.md)\n- [機能要件書: FR-026](../../docs/functional-requirements/FR-023-027_visualization.md#fr-026-金融機関別資産残高表示)\n- [既存実装: CalculateMonthlyBalanceUseCase](../../apps/backend/src/modules/transaction/application/use-cases/calculate-monthly-balance.use-case.ts) - 前月・前年同月の計算ロジックの参考\n\n## 見積もり工数\n\n- **アプローチ1（履歴テーブル）**: 5〜7日\n- **アプローチ2（取引データから逆算）**: 3〜5日\n\n## 備考\n\n- アプローチ1を推奨しますが、要件や制約に応じてアプローチ2も検討可能です\n- 初期実装では、履歴データが存在しない場合でもエラーにならないよう、0を返す実装を維持します\n- バッチ処理の実装は別Issueに分離することも検討可能です"
}
