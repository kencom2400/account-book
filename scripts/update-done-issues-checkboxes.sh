#!/bin/bash

# CloseされたIssueのチェックボックスを実装状況に応じて更新

REPO="kencom2400/account-book"
CLOSED_ISSUES=(5 6 7 8 9 11 12 13 14 138)

echo "════════════════════════════════════════════════════════════════"
echo "   📝 CloseされたIssueのチェックボックス更新"
echo "════════════════════════════════════════════════════════════════"
echo ""

for issue_num in "${CLOSED_ISSUES[@]}"; do
    echo "────────────────────────────────────────────────────────────────"
    echo "Issue #$issue_num の処理中..."
    echo "────────────────────────────────────────────────────────────────"
    
    # Issueの本文を取得
    issue_body=$(gh issue view "$issue_num" --repo "$REPO" --json body --jq '.body')
    
    # 完了条件に基づいてチェックボックスを更新
    case $issue_num in
        5)
            # A-1: Monorepo環境
            echo "✅ A-1: Monorepo環境の最終確認と整備"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] ESLint\/Prettierエラーがない/- [x] ESLint\/Prettierエラーがない/' \
                -e 's/- \[ \] TypeScript型定義が適切に設定されている/- [x] TypeScript型定義が適切に設定されている/')
            ;;
        6)
            # A-2: ESLint・Prettier
            echo "✅ A-2: ESLint・Prettierの設定と適用"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] ESLint\/Prettierエラーがない/- [x] ESLint\/Prettierエラーがない/')
            ;;
        7)
            # A-3: Backend基盤
            echo "✅ A-3: Backend基盤の構築（NestJS）"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] ESLint\/Prettierエラーがない/- [x] ESLint\/Prettierエラーがない/' \
                -e 's/- \[ \] TypeScript型定義が適切に設定されている/- [x] TypeScript型定義が適切に設定されている/' \
                -e 's/- \[ \] API仕様に準拠している（Backend の場合）/- [x] API仕様に準拠している（Backend の場合）/')
            ;;
        8)
            # A-4: Frontend基盤
            echo "✅ A-4: Frontend基盤の構築（Next.js）"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] ESLint\/Prettierエラーがない/- [x] ESLint\/Prettierエラーがない/' \
                -e 's/- \[ \] TypeScript型定義が適切に設定されている/- [x] TypeScript型定義が適切に設定されている/' \
                -e 's/- \[ \] UI\/UXが使いやすい（Frontend の場合）/- [x] UI\/UXが使いやすい（Frontend の場合）/')
            ;;
        9)
            # A-5: 開発用スクリプト
            echo "✅ A-5: 開発用スクリプト群の整備"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] README\.mdが更新されている（必要に応じて）/- [x] README.mdが更新されている（必要に応じて）/')
            ;;
        11)
            # A-7: GitHub Issue管理環境
            echo "✅ A-7: GitHub Issue管理環境の構築"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] README\.mdが更新されている（必要に応じて）/- [x] README.mdが更新されている（必要に応じて）/')
            ;;
        12)
            # A-8: データディレクトリ
            echo "✅ A-8: データディレクトリ構造の整備"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/')
            ;;
        13)
            # A-9: カテゴリマスタ
            echo "✅ A-9: カテゴリマスタデータの初期化"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/')
            ;;
        14)
            # A-10: ドキュメント整備
            echo "✅ A-10: ドキュメント整備"
            updated_body=$(echo "$issue_body" | sed \
                -e 's/- \[ \] 実装が要件定義に沿って完了している/- [x] 実装が要件定義に沿って完了している/' \
                -e 's/- \[ \] 正常系の動作が確認できている/- [x] 正常系の動作が確認できている/' \
                -e 's/- \[ \] 実装が完了している/- [x] 実装が完了している/' \
                -e 's/- \[ \] README\.mdが更新されている（必要に応じて）/- [x] README.mdが更新されている（必要に応じて）/')
            ;;
        138)
            # Issue #138は既にすべてチェック済み
            echo "✅ Issue #138: 既にすべてチェック済み"
            echo "  スキップします"
            continue
            ;;
    esac
    
    # Issueの本文を更新
    echo "  本文を更新中..."
    gh issue edit "$issue_num" --repo "$REPO" --body "$updated_body" 2>&1
    
    if [ $? -eq 0 ]; then
        echo "  ✅ 更新完了"
    else
        echo "  ❌ 更新エラー"
    fi
    
    echo ""
    sleep 1
done

echo "════════════════════════════════════════════════════════════════"
echo "   ✅ 完了"
echo "════════════════════════════════════════════════════════════════"

