name: Update Project Status on Close

on:
  issues:
    types: [closed]
  pull_request:
    types: [closed]

jobs:
  update-status:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
      repository-projects: write
      contents: read

    steps:
      - name: Update Project Status to Done
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issueNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            
            if (!issueNumber) {
              console.log('No issue or PR number found');
              return;
            }
            
            console.log(`Processing issue/PR #${issueNumber}...`);
            
            try {
              // GraphQL API„Åß„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÉÖÂ†±„ÇíÂèñÂæó
              const query = `
                query {
                  repository(owner: "${owner}", name: "${repo}") {
                    issueOrPullRequest(number: ${issueNumber}) {
                      ... on Issue {
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              id
                              title
                            }
                            fieldValueByName(name: "Status") {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                id
                                name
                              }
                            }
                          }
                        }
                      }
                      ... on PullRequest {
                        projectItems(first: 10) {
                          nodes {
                            id
                            project {
                              id
                              title
                            }
                            fieldValueByName(name: "Status") {
                              ... on ProjectV2ItemFieldSingleSelectValue {
                                id
                                name
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              `;
              
              const result = await github.graphql(query);
              const projectItems = result.repository.issueOrPullRequest.projectItems.nodes;
              
              if (projectItems.length === 0) {
                console.log('‚úÖ Issue/PR is not in any project. Nothing to update.');
                return;
              }
              
              // ÂêÑ„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Ç¢„Ç§„ÉÜ„É†„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„Çí„ÄåDone„Äç„Å´Êõ¥Êñ∞
              for (const item of projectItems) {
                const currentStatus = item.fieldValueByName?.name;
                
                console.log(`üìã Project: ${item.project.title}`);
                console.log(`   Current Status: ${currentStatus || 'No Status'}`);
                
                if (currentStatus === '‚úÖ Done') {
                  console.log('   ‚úÖ Already marked as Done. Skipping.');
                  continue;
                }
                
                console.log('   üîÑ Updating status to Done...');
                
                // Status„Éï„Ç£„Éº„É´„Éâ„ÅÆID„Å®Done„Ç™„Éó„Ç∑„Éß„É≥ID„ÇíÂèñÂæó
                const projectQuery = `
                  query {
                    node(id: "${item.project.id}") {
                      ... on ProjectV2 {
                        field(name: "Status") {
                          ... on ProjectV2SingleSelectField {
                            id
                            options {
                              id
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                `;
                
                const projectData = await github.graphql(projectQuery);
                const statusField = projectData.node.field;
                const doneOption = statusField.options.find(opt => opt.name === '‚úÖ Done');
                
                if (!doneOption) {
                  console.log('   ‚ö†Ô∏è  Done option not found in project. Skipping.');
                  continue;
                }
                
                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                const updateMutation = `
                  mutation {
                    updateProjectV2ItemFieldValue(input: {
                      projectId: "${item.project.id}"
                      itemId: "${item.id}"
                      fieldId: "${statusField.id}"
                      value: {
                        singleSelectOptionId: "${doneOption.id}"
                      }
                    }) {
                      projectV2Item {
                        id
                      }
                    }
                  }
                `;
                
                await github.graphql(updateMutation);
                console.log(`   ‚úÖ Successfully updated to Done in project ${item.project.title}`);
              }
              
              console.log('');
              console.log('üéâ All project statuses updated successfully!');
            } catch (error) {
              console.error('‚ùå Error updating project status:', error);
              console.error('Note: This is non-critical. The workflow will continue.');
              // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇ„ÉØ„Éº„ÇØ„Éï„É≠„ÉºÂÖ®‰Ωì„ÅØÂ§±Êïó„Åï„Åõ„Å™„ÅÑ
            }

